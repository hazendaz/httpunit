<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JavaScript.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">httpunit</a> &gt; <a href="index.source.html" class="el_package">com.meterware.httpunit.javascript</a> &gt; <span class="el_source">JavaScript.java</span></div><h1>JavaScript.java</h1><pre class="source lang-java linenums">/*
 * MIT License
 *
 * Copyright 2011-2024 Russell Gold
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated
 * documentation files (the &quot;Software&quot;), to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and
 * to permit persons to whom the Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions
 * of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO
 * THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
 * DEALINGS IN THE SOFTWARE.
 */
package com.meterware.httpunit.javascript;

import com.meterware.httpunit.ClientProperties;
import com.meterware.httpunit.HTMLPage;
import com.meterware.httpunit.HttpUnitOptions;
import com.meterware.httpunit.HttpUnitUtils;
import com.meterware.httpunit.WebForm;
import com.meterware.httpunit.WebImage;
import com.meterware.httpunit.WebLink;
import com.meterware.httpunit.WebResponse;
import com.meterware.httpunit.javascript.events.EventException;
import com.meterware.httpunit.javascript.events.EventTarget;
import com.meterware.httpunit.scripting.DocumentElement;
import com.meterware.httpunit.scripting.FormScriptable;
import com.meterware.httpunit.scripting.IdentifiedDelegate;
import com.meterware.httpunit.scripting.Input;
import com.meterware.httpunit.scripting.NamedDelegate;
import com.meterware.httpunit.scripting.ScriptableDelegate;
import com.meterware.httpunit.scripting.ScriptingEngine;
import com.meterware.httpunit.scripting.ScriptingHandler;
import com.meterware.httpunit.scripting.SelectionOption;
import com.meterware.httpunit.scripting.SelectionOptions;

import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.net.URL;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;

import org.mozilla.javascript.Context;
import org.mozilla.javascript.EvaluatorException;
import org.mozilla.javascript.JavaScriptException;
import org.mozilla.javascript.Scriptable;
import org.mozilla.javascript.ScriptableObject;
import org.mozilla.javascript.Undefined;
import org.xml.sax.SAXException;

/**
 * This class is the Rhino-compatible implementation of the JavaScript DOM objects.
 *
 * @author &lt;a href=&quot;mailto:russgold@httpunit.org&quot;&gt;Russell Gold&lt;/a&gt;
 **/
<span class="nc" id="L64">public class JavaScript {</span>

<span class="fc" id="L66">    private static boolean _throwExceptionsOnError = true;</span>

    public static boolean isThrowExceptionsOnError() {
<span class="fc" id="L69">        return _throwExceptionsOnError;</span>
    }

    public static void setThrowExceptionsOnError(boolean throwExceptionsOnError) {
<span class="fc" id="L73">        _throwExceptionsOnError = throwExceptionsOnError;</span>
<span class="fc" id="L74">    }</span>

    /**
     * Initiates JavaScript execution for the specified web response.
     */
    public static void run(WebResponse response) throws IllegalAccessException, InstantiationException,
    InvocationTargetException, EvaluatorException, EvaluatorException, SAXException, JavaScriptException {
<span class="fc" id="L81">        Context context = Context.enter();</span>
        // suggest bug fix for large java scripts see
        // bug report [ 1216567 ] Exception for large javascripts
        // by Grzegorz Lukasik
        // and

<span class="fc" id="L87">        context.setOptimizationLevel(HttpUnitOptions.getJavaScriptOptimizationLevel());</span>
<span class="fc" id="L88">        Scriptable scope = context.initStandardObjects(null);</span>
<span class="fc" id="L89">        initHTMLObjects(scope);</span>

<span class="fc" id="L91">        Window w = (Window) context.newObject(scope, &quot;Window&quot;);</span>
<span class="fc" id="L92">        w.initialize(null, response.getScriptableObject());</span>
<span class="fc" id="L93">    }</span>

    /**
     * Runs the onload event for the specified web response.
     */
    public static void load(WebResponse response) throws EvaluatorException, InstantiationException,
    IllegalAccessException, InvocationTargetException, JavaScriptException, SAXException, EvaluatorException {
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">        if (!(response.getScriptableObject().getScriptEngine() instanceof JavaScriptEngine)) {</span>
<span class="nc" id="L101">            run(response);</span>
        }
<span class="fc" id="L103">        response.getScriptableObject().load();</span>
<span class="fc" id="L104">    }</span>

    private static void initHTMLObjects(Scriptable scope)
            throws IllegalAccessException, InstantiationException, InvocationTargetException, EvaluatorException {
<span class="fc" id="L108">        ScriptableObject.defineClass(scope, Window.class);</span>
<span class="fc" id="L109">        ScriptableObject.defineClass(scope, Document.class);</span>
<span class="fc" id="L110">        ScriptableObject.defineClass(scope, Style.class);</span>
<span class="fc" id="L111">        ScriptableObject.defineClass(scope, Location.class);</span>
<span class="fc" id="L112">        ScriptableObject.defineClass(scope, Navigator.class);</span>
<span class="fc" id="L113">        ScriptableObject.defineClass(scope, Screen.class);</span>
<span class="fc" id="L114">        ScriptableObject.defineClass(scope, Link.class);</span>
<span class="fc" id="L115">        ScriptableObject.defineClass(scope, Form.class);</span>
<span class="fc" id="L116">        ScriptableObject.defineClass(scope, Control.class);</span>
<span class="fc" id="L117">        ScriptableObject.defineClass(scope, Link.class);</span>
<span class="fc" id="L118">        ScriptableObject.defineClass(scope, Image.class);</span>
<span class="fc" id="L119">        ScriptableObject.defineClass(scope, Options.class);</span>
<span class="fc" id="L120">        ScriptableObject.defineClass(scope, Option.class);</span>
<span class="fc" id="L121">        ScriptableObject.defineClass(scope, ElementArray.class);</span>
<span class="fc" id="L122">        ScriptableObject.defineClass(scope, HTMLElement.class);</span>
<span class="fc" id="L123">    }</span>

    /**
     * abstract Engine for JavaScript
     */
<span class="fc" id="L128">    abstract static class JavaScriptEngine extends ScriptingEngineImpl implements EventTarget {</span>

        private static final long serialVersionUID = 1L;
        protected ScriptableDelegate _scriptable;
        protected JavaScriptEngine _parent;
<span class="fc" id="L133">        protected Map _eventListeners = new HashMap(); // Map&lt;String,Set&lt;EventListener&gt;&gt;</span>
<span class="fc" id="L134">        protected Map _eventCaptureListeners = new HashMap(); // Map&lt;String,Set&lt;EventListener&gt;&gt;</span>

        /**
         * initialize JavaScript for the given ScriptEngine
         *
         * @parent - the Script Engine to use
         *
         * @scriptable - the scriptable object to do the initialization for
         */
        void initialize(JavaScriptEngine parent, ScriptableDelegate scriptable)
                throws SAXException, JavaScriptException, EvaluatorException {
<span class="fc" id="L145">            _scriptable = scriptable;</span>
<span class="fc" id="L146">            _scriptable.setScriptEngine(this);</span>
<span class="fc" id="L147">            _parent = parent;</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">            if (parent != null) {</span>
<span class="fc" id="L149">                setParentScope(parent);</span>
            }
<span class="fc" id="L151">        }</span>

        String getName() {
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">            return _scriptable instanceof NamedDelegate ? ((NamedDelegate) _scriptable).getName() : &quot;&quot;;</span>
        }

        String getID() {
<span class="fc bfc" id="L158" title="All 2 branches covered.">            return _scriptable instanceof IdentifiedDelegate ? ((IdentifiedDelegate) _scriptable).getID() : &quot;&quot;;</span>
        }

        /**
         * get the event Handler script for the event e.g. onchange, onmousedown, onclick, onmouseup execute the script
         * if it's assigned by calling doEvent for the script
         *
         * @param eventName
         *
         * @return
         */
        @Override
        public boolean handleEvent(String eventName) {
<span class="nc" id="L171">            return _scriptable.handleEvent(eventName);</span>
        }

        @Override
        public boolean has(String propertyName, Scriptable scriptable) {
<span class="fc bfc" id="L176" title="All 4 branches covered.">            return super.has(propertyName, scriptable)</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">                    || _scriptable != null &amp;&amp; _scriptable.get(propertyName) != null;</span>
        }

        @Override
        public Object get(String propertyName, Scriptable scriptable) {
<span class="fc" id="L182">            Object result = super.get(propertyName, scriptable);</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">            if (result != NOT_FOUND) {</span>
<span class="fc" id="L184">                return result;</span>
            }
<span class="fc bfc" id="L186" title="All 2 branches covered.">            if (_scriptable == null) {</span>
<span class="fc" id="L187">                return NOT_FOUND;</span>
            }

<span class="fc" id="L190">            return convertIfNeeded(_scriptable.get(propertyName));</span>

        }

        @Override
        public Object get(int i, Scriptable scriptable) {
<span class="fc" id="L196">            Object result = super.get(i, scriptable);</span>
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">            if (result != NOT_FOUND) {</span>
<span class="nc" id="L198">                return result;</span>
            }
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">            if (_scriptable == null) {</span>
<span class="nc" id="L201">                return NOT_FOUND;</span>
            }

<span class="fc" id="L204">            return convertIfNeeded(_scriptable.get(i));</span>
        }

        private Object convertIfNeeded(final Object property) {
<span class="fc bfc" id="L208" title="All 2 branches covered.">            if (property == null) {</span>
<span class="fc" id="L209">                return NOT_FOUND;</span>
            }

<span class="fc bfc" id="L212" title="All 2 branches covered.">            if (property instanceof ScriptableDelegate[]) {</span>
<span class="fc" id="L213">                return toScriptable((ScriptableDelegate[]) property);</span>
            }
<span class="fc bfc" id="L215" title="All 2 branches covered.">            if (!(property instanceof ScriptableDelegate)) {</span>
<span class="fc" id="L216">                return property;</span>
            }
<span class="fc" id="L218">            return toScriptable((ScriptableDelegate) property);</span>
        }

        private Object toScriptable(ScriptableDelegate[] list) {
<span class="fc" id="L222">            Object[] delegates = new Object[list.length];</span>
<span class="fc bfc" id="L223" title="All 2 branches covered.">            for (int i = 0; i &lt; delegates.length; i++) {</span>
<span class="fc" id="L224">                delegates[i] = toScriptable(list[i]);</span>
            }
<span class="fc" id="L226">            return Context.getCurrentContext().newArray(this, delegates);</span>
        }

        @Override
        public void put(String propertyName, Scriptable scriptable, Object value) {
<span class="fc bfc" id="L231" title="All 4 branches covered.">            if (_scriptable == null || _scriptable.get(propertyName) == null) {</span>
<span class="fc" id="L232">                super.put(propertyName, scriptable, value);</span>
            } else {
<span class="fc" id="L234">                _scriptable.set(propertyName, value);</span>
            }
<span class="fc" id="L236">        }</span>

        @Override
        public String toString() {
<span class="nc bnc" id="L240" title="All 2 branches missed.">            return (_scriptable == null ? &quot;prototype &quot; : &quot;&quot;) + getClassName();</span>
        }

        @Override
        public ScriptingEngine newScriptingEngine(ScriptableDelegate child) {
            try {
<span class="fc" id="L246">                return (ScriptingEngine) toScriptable(child);</span>
<span class="nc" id="L247">            } catch (Exception e) {</span>
<span class="nc" id="L248">                HttpUnitUtils.handleException(e);</span>
<span class="nc" id="L249">                throw new RuntimeException(e.toString());</span>
            }
        }

        @Override
        public void clearCaches() {
<span class="nc" id="L255">        }</span>

        protected static String toStringIfNotUndefined(Object object) {
<span class="pc bpc" id="L258" title="1 of 4 branches missed.">            return object == null || Undefined.instance.equals(object) ? null : object.toString();</span>
        }

        /**
         * Converts a scriptable delegate obtained from a subobject into the appropriate Rhino-compatible Scriptable.
         **/
        final Object toScriptable(ScriptableDelegate delegate) {
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">            if (delegate == null) {</span>
<span class="nc" id="L266">                return NOT_FOUND;</span>
            }
<span class="fc bfc" id="L268" title="All 2 branches covered.">            if (delegate.getScriptEngine() instanceof Scriptable) {</span>
<span class="fc" id="L269">                return delegate.getScriptEngine();</span>
            }
            try {
<span class="fc" id="L272">                JavaScriptEngine element = (JavaScriptEngine) Context.getCurrentContext().newObject(this,</span>
<span class="fc" id="L273">                        getScriptableClassName(delegate));</span>
<span class="fc" id="L274">                element.initialize(this, delegate);</span>
<span class="fc" id="L275">                return element;</span>
<span class="nc" id="L276">            } catch (RuntimeException e) {</span>
<span class="nc" id="L277">                throw e;</span>
<span class="nc" id="L278">            } catch (Exception e) {</span>
<span class="nc" id="L279">                throw new RhinoException(e);</span>
            }
        }

        /**
         * get the classname of the given ScriptableDelegate
         *
         * @param delegate
         *            - the object to get the class name for
         *
         * @return - the simple local class name for the delegate e.g. Window, Document, Form, Link, Image, Options,
         *         Option, Control, HTMLElement
         *
         * @throws an
         *             IllegalArgumentException if the delegate is not known
         */
        private String getScriptableClassName(ScriptableDelegate delegate) {
<span class="fc bfc" id="L296" title="All 2 branches covered.">            if (delegate instanceof WebResponse.Scriptable) {</span>
<span class="fc" id="L297">                return &quot;Window&quot;;</span>
            }
<span class="fc bfc" id="L299" title="All 2 branches covered.">            if (delegate instanceof HTMLPage.Scriptable) {</span>
<span class="fc" id="L300">                return &quot;Document&quot;;</span>
            }
<span class="fc bfc" id="L302" title="All 2 branches covered.">            if (delegate instanceof FormScriptable) {</span>
<span class="fc" id="L303">                return &quot;Form&quot;;</span>
            }
<span class="fc bfc" id="L305" title="All 2 branches covered.">            if (delegate instanceof WebLink.Scriptable) {</span>
<span class="fc" id="L306">                return &quot;Link&quot;;</span>
            }
<span class="fc bfc" id="L308" title="All 2 branches covered.">            if (delegate instanceof WebImage.Scriptable) {</span>
<span class="fc" id="L309">                return &quot;Image&quot;;</span>
            }
<span class="fc bfc" id="L311" title="All 2 branches covered.">            if (delegate instanceof SelectionOptions) {</span>
<span class="fc" id="L312">                return &quot;Options&quot;;</span>
            }
<span class="fc bfc" id="L314" title="All 2 branches covered.">            if (delegate instanceof SelectionOption) {</span>
<span class="fc" id="L315">                return &quot;Option&quot;;</span>
            }
<span class="fc bfc" id="L317" title="All 2 branches covered.">            if (delegate instanceof Input) {</span>
<span class="fc" id="L318">                return &quot;Control&quot;;</span>
            }
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">            if (delegate instanceof DocumentElement) {</span>
<span class="fc" id="L321">                return &quot;HTMLElement&quot;;</span>
            }

<span class="nc" id="L324">            throw new IllegalArgumentException(&quot;Unknown ScriptableDelegate class: &quot; + delegate.getClass());</span>
        }

        protected ElementArray toElementArray(ScriptingHandler[] scriptables) {
<span class="fc" id="L328">            JavaScriptEngine[] elements = new JavaScriptEngine[scriptables.length];</span>
<span class="fc bfc" id="L329" title="All 2 branches covered.">            for (int i = 0; i &lt; elements.length; i++) {</span>
<span class="fc" id="L330">                elements[i] = (JavaScriptEngine) toScriptable((ScriptableDelegate) scriptables[i]);</span>
            }
<span class="fc" id="L332">            ElementArray result = ElementArray.newElementArray(this);</span>
<span class="fc" id="L333">            result.initialize(elements);</span>
<span class="fc" id="L334">            return result;</span>
        }

        /**
         * {@inheritDoc}
         */
        @Override
        public void jsFunction_addEventListener(String type, Scriptable listener, boolean useCapture) {
<span class="nc bnc" id="L342" title="All 2 branches missed.">            if (useCapture) {</span>
<span class="nc" id="L343">                Set set = (Set) _eventCaptureListeners.get(type); // Set&lt;Scriptable&gt;</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">                if (set == null) {</span>
<span class="nc" id="L345">                    set = new HashSet();</span>
<span class="nc" id="L346">                    _eventCaptureListeners.put(type, set);</span>
                }
<span class="nc" id="L348">                set.add(listener);</span>
<span class="nc" id="L349">            } else {</span>
<span class="nc" id="L350">                Set set = (Set) _eventListeners.get(type); // Set&lt;Scriptable&gt;</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">                if (set == null) {</span>
<span class="nc" id="L352">                    set = new HashSet();</span>
<span class="nc" id="L353">                    _eventListeners.put(type, set);</span>
                }
<span class="nc" id="L355">                set.add(listener);</span>
            }
            // System.out.println(getClassName()+&quot;.addEventListener(&quot;+type+&quot;)&quot;);
<span class="nc" id="L358">        }</span>

        /**
         * {@inheritDoc}
         */
        @Override
        public boolean jsFunction_dispatchEvent(Scriptable evt) throws EventException {
            // TODO implement event dispatching &amp; listener invocation
            // System.out.println(getClassName()+&quot;.dispatchEvent(&quot;+evt.get(&quot;type&quot;,evt)+&quot;)&quot;);
<span class="nc" id="L367">            return true;</span>
        }

        /**
         * {@inheritDoc}
         */
        @Override
        public void jsFunction_removeEventListener(String type, Scriptable listener, boolean useCapture) {
<span class="nc bnc" id="L375" title="All 2 branches missed.">            if (useCapture) {</span>
<span class="nc" id="L376">                Set set = (Set) _eventCaptureListeners.get(type); // Set&lt;EventListener&gt;</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">                if (set != null) {</span>
<span class="nc" id="L378">                    set.remove(listener);</span>
                }
<span class="nc" id="L380">            } else {</span>
<span class="nc" id="L381">                Set set = (Set) _eventListeners.get(type); // Set&lt;EventListener&gt;</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">                if (set != null) {</span>
<span class="nc" id="L383">                    set.remove(listener);</span>
                }
            }
            // System.out.println(getClassName()+&quot;.removeEventListener(&quot;+type+&quot;)&quot;);
<span class="nc" id="L387">        }</span>
    }

    /**
     * Window functions
     */
<span class="fc" id="L393">    static public class Window extends JavaScriptEngine {</span>

        private static final long serialVersionUID = 1L;
        private Document _document;
        private Navigator _navigator;
        private Location _location;
        private Screen _screen;
        private ElementArray _frames;

        @Override
        public String getClassName() {
<span class="fc" id="L404">            return &quot;Window&quot;;</span>
        }

        public Window jsGet_window() {
<span class="fc" id="L408">            return this;</span>
        }

        public Window jsGet_self() {
<span class="nc" id="L412">            return this;</span>
        }

        public Document jsGet_document() {
<span class="fc bfc" id="L416" title="All 2 branches covered.">            if (_document == null) {</span>
<span class="fc" id="L417">                _document = (Document) toScriptable(getDelegate().getDocument());</span>
            }
<span class="fc" id="L419">            return _document;</span>
        }

        public Scriptable jsGet_frames() throws SAXException, JavaScriptException, EvaluatorException {
<span class="fc bfc" id="L423" title="All 2 branches covered.">            if (_frames == null) {</span>
<span class="fc" id="L424">                WebResponse.Scriptable scriptables[] = getDelegate().getFrames();</span>
<span class="fc" id="L425">                Window[] frames = new Window[scriptables.length];</span>
<span class="fc bfc" id="L426" title="All 2 branches covered.">                for (int i = 0; i &lt; frames.length; i++) {</span>
<span class="fc" id="L427">                    frames[i] = (Window) toScriptable(scriptables[i]);</span>
                }
<span class="fc" id="L429">                _frames = (ElementArray) Context.getCurrentContext().newObject(this, &quot;ElementArray&quot;);</span>
<span class="fc" id="L430">                _frames.initialize(frames);</span>
            }
<span class="fc" id="L432">            return _frames;</span>
        }

        public Navigator jsGet_navigator() {
<span class="fc" id="L436">            return _navigator;</span>
        }

        public Screen jsGet_screen() {
<span class="fc" id="L440">            return _screen;</span>
        }

        public Location jsGet_location() {
<span class="fc" id="L444">            return _location;</span>
        }

        public void jsSet_location(String relativeURL) throws IOException, SAXException {
<span class="fc" id="L448">            setLocation(relativeURL);</span>
<span class="fc" id="L449">        }</span>

        void setLocation(String relativeURL) throws IOException, SAXException {
<span class="fc" id="L452">            getDelegate().setLocation(relativeURL);</span>
<span class="fc" id="L453">        }</span>

        /**
         * initialize JavaScript for the given ScriptEngine
         *
         * @parent - the Script Engine to use
         *
         * @scriptable - the scriptable object to do the initialization for
         */
        @Override
        void initialize(JavaScriptEngine parent, ScriptableDelegate scriptable)
                throws JavaScriptException, EvaluatorException, SAXException {
<span class="fc" id="L465">            super.initialize(parent, scriptable);</span>

<span class="fc" id="L467">            _location = (Location) Context.getCurrentContext().newObject(this, &quot;Location&quot;);</span>
<span class="fc" id="L468">            _location.initialize(this, ((WebResponse.Scriptable) scriptable).getURL());</span>

<span class="fc" id="L470">            _navigator = (Navigator) Context.getCurrentContext().newObject(this, &quot;Navigator&quot;);</span>
<span class="fc" id="L471">            _navigator.setClientProperties(getDelegate().getClientProperties());</span>

<span class="fc" id="L473">            _screen = (Screen) Context.getCurrentContext().newObject(this, &quot;Screen&quot;);</span>
<span class="fc" id="L474">            _screen.setClientProperties(getDelegate().getClientProperties());</span>
<span class="fc" id="L475">        }</span>

        /**
         * javascript alert handling
         *
         * @param message
         *            - the alert message
         */
        public void jsFunction_alert(String message) {
<span class="fc" id="L484">            getDelegate().alertUser(message);</span>
<span class="fc" id="L485">        }</span>

        /**
         * javascript built in function &quot;toLowerCase&quot;
         *
         * @param s
         */
        public String jsFunction_toLowerCase(String s) {
<span class="fc" id="L493">            return s.toLowerCase();</span>
        }

        public boolean jsFunction_confirm(String message) {
<span class="fc" id="L497">            return getDelegate().getConfirmationResponse(message);</span>
        }

        public String jsFunction_prompt(String message, String defaultResponse) {
<span class="fc" id="L501">            return getDelegate().getUserResponse(message, defaultResponse);</span>
        }

        public void jsFunction_moveTo(int x, int y) {
<span class="nc" id="L505">        }</span>

        public void jsFunction_scrollTo(int x, int y) {
<span class="nc" id="L508">        }</span>

        public void jsFunction_focus() {
<span class="nc" id="L511">        }</span>

        public void jsFunction_setTimeout() {
<span class="nc" id="L514">        }</span>

        public void jsFunction_close() {
<span class="fc" id="L517">            getDelegate().closeWindow();</span>
<span class="fc" id="L518">        }</span>

        public Window jsFunction_open(Object url, String name, String features, boolean replace)
                throws JavaScriptException, EvaluatorException, IOException, SAXException {
<span class="fc" id="L522">            WebResponse.Scriptable delegate = getDelegate().open(toStringIfNotUndefined(url), name, features, replace);</span>
<span class="fc bfc" id="L523" title="All 2 branches covered.">            return delegate == null ? null : (Window) toScriptable(delegate);</span>
        }

        /** The global &quot;event&quot; object is not supported, so return null (instead of causing '&quot;event&quot; is not defined') */
        public Location jsGet_event() {
<span class="nc" id="L528">            return null;</span>
        }

        @Override
        public void clearCaches() {
<span class="fc bfc" id="L533" title="All 2 branches covered.">            if (_document != null) {</span>
<span class="fc" id="L534">                _document.clearCaches();</span>
            }
<span class="fc" id="L536">        }</span>

        @Override
        protected String getDocumentWriteBuffer() {
<span class="fc" id="L540">            return jsGet_document().getWriteBuffer().toString();</span>
        }

        @Override
        protected void discardDocumentWriteBuffer() {
<span class="fc" id="L545">            jsGet_document().clearWriteBuffer();</span>
<span class="fc" id="L546">        }</span>

        private WebResponse.Scriptable getDelegate() {
<span class="fc" id="L549">            return (WebResponse.Scriptable) _scriptable;</span>
        }
    }

    /**
     * Document script handling
     */
<span class="fc" id="L556">    static public class Document extends JavaScriptEngine {</span>

        private static final long serialVersionUID = 1L;
        private ElementArray _forms;
        private ElementArray _links;
        private ElementArray _images;
        private StringBuilder _writeBuffer;
        private String _mimeType;

        @Override
        public String getClassName() {
<span class="fc" id="L567">            return &quot;Document&quot;;</span>
        }

        @Override
        public void clearCaches() {
<span class="fc" id="L572">            _forms = _links = _images = null;</span>
<span class="fc" id="L573">        }</span>

        public String jsGet_title() throws SAXException {
<span class="fc" id="L576">            return getDelegate().getTitle();</span>
        }

        public Scriptable jsGet_images() throws SAXException {
<span class="fc bfc" id="L580" title="All 2 branches covered.">            if (_images == null) {</span>
<span class="fc" id="L581">                _images = toElementArray(getDelegate().getImages());</span>
            }
<span class="fc" id="L583">            return _images;</span>
        }

        public Scriptable jsGet_links() throws SAXException {
<span class="fc bfc" id="L587" title="All 2 branches covered.">            if (_links == null) {</span>
<span class="fc" id="L588">                _links = toElementArray(getDelegate().getLinks());</span>
            }
<span class="fc" id="L590">            return _links;</span>
        }

        public Scriptable jsGet_forms() throws SAXException {
<span class="fc bfc" id="L594" title="All 2 branches covered.">            if (_forms == null) {</span>
<span class="fc" id="L595">                _forms = toElementArray(getDelegate().getForms());</span>
            }
<span class="fc" id="L597">            return _forms;</span>
        }

        public Object jsFunction_getElementById(String id) {
<span class="fc" id="L601">            ScriptableDelegate elementWithID = getDelegate().getElementWithID(id);</span>
<span class="fc bfc" id="L602" title="All 2 branches covered.">            return elementWithID == null ? null : toScriptable(elementWithID);</span>
        }

        public Object jsFunction_getElementsByName(String name) {
<span class="fc" id="L606">            return toElementArray(getDelegate().getElementsByName(name));</span>
        }

        public Object jsFunction_getElementsByTagName(String name) {
<span class="fc" id="L610">            return toElementArray(getDelegate().getElementsByTagName(name));</span>
        }

        public Object jsGet_location() {
<span class="pc bpc" id="L614" title="1 of 2 branches missed.">            return _parent == null ? NOT_FOUND : getWindow().jsGet_location();</span>
        }

        public void jsSet_location(String urlString) throws IOException, SAXException {
<span class="pc bpc" id="L618" title="1 of 2 branches missed.">            if (urlString.startsWith(&quot;color&quot;)) {</span>
<span class="nc" id="L619">                return;</span>
            }
<span class="fc" id="L621">            getWindow().setLocation(urlString);</span>
<span class="fc" id="L622">        }</span>

        public String jsGet_cookie() {
<span class="fc" id="L625">            return getDelegate().getCookie();</span>
        }

        public void jsSet_cookie(String cookieSpec) {
<span class="fc" id="L629">            final int equalsIndex = cookieSpec.indexOf('=');</span>
<span class="fc bfc" id="L630" title="All 2 branches covered.">            if (equalsIndex &lt; 0) {</span>
<span class="fc" id="L631">                return;</span>
            }
<span class="fc" id="L633">            int endIndex = cookieSpec.indexOf(&quot;;&quot;, equalsIndex);</span>
<span class="pc bpc" id="L634" title="1 of 2 branches missed.">            if (endIndex &lt; 0) {</span>
<span class="nc" id="L635">                endIndex = cookieSpec.length();</span>
            }
<span class="fc" id="L637">            String name = cookieSpec.substring(0, equalsIndex);</span>
<span class="fc" id="L638">            String value = cookieSpec.substring(equalsIndex + 1, endIndex);</span>
<span class="fc" id="L639">            getDelegate().setCookie(name, value);</span>
<span class="fc" id="L640">        }</span>

        private Window getWindow() {
<span class="fc" id="L643">            return (Window) _parent;</span>
        }

        public void jsFunction_open(Object mimeType) {
<span class="fc" id="L647">            _mimeType = toStringIfNotUndefined(mimeType);</span>
<span class="fc" id="L648">        }</span>

        public void jsFunction_close() {
<span class="fc bfc" id="L651" title="All 4 branches covered.">            if (getDelegate().replaceText(getWriteBuffer().toString(), _mimeType == null ? &quot;text/html&quot; : _mimeType)) {</span>
<span class="fc" id="L652">                getWriteBuffer().setLength(0);</span>
            }
<span class="fc" id="L654">        }</span>

        public void jsFunction_write(String string) {
<span class="fc" id="L657">            getWriteBuffer().append(string);</span>
<span class="fc" id="L658">        }</span>

        public void jsFunction_writeln(String string) {
<span class="fc" id="L661">            getWriteBuffer().append(string).append((char) 0x0D).append((char) 0x0A);</span>
<span class="fc" id="L662">        }</span>

        protected StringBuilder getWriteBuffer() {
<span class="fc bfc" id="L665" title="All 2 branches covered.">            if (_writeBuffer == null) {</span>
<span class="fc" id="L666">                _writeBuffer = new StringBuilder();</span>
            }
<span class="fc" id="L668">            return _writeBuffer;</span>
        }

        protected void clearWriteBuffer() {
<span class="fc" id="L672">            _writeBuffer = null;</span>
<span class="fc" id="L673">        }</span>

        private HTMLPage.Scriptable getDelegate() {
<span class="fc" id="L676">            return (HTMLPage.Scriptable) _scriptable;</span>
        }

        @Override
        public void jsFunction_addEventListener(String type, Scriptable listener, boolean useCapture) {
            // TODO Auto-generated method stub

<span class="nc" id="L683">        }</span>

        @Override
        public boolean jsFunction_dispatchEvent(Scriptable evt) throws EventException {
            // TODO Auto-generated method stub
<span class="nc" id="L688">            return false;</span>
        }

        @Override
        public void jsFunction_removeEventListener(String type, Scriptable listener, boolean useCapture) {
            // TODO Auto-generated method stub

<span class="nc" id="L695">        }</span>

    }

<span class="fc" id="L699">    static public class Location extends JavaScriptEngine {</span>

        private static final long serialVersionUID = 1L;
        private URL _url;
        private Window _window;

        @Override
        public String getClassName() {
<span class="fc" id="L707">            return &quot;Location&quot;;</span>
        }

        void initialize(Window window, URL url) {
<span class="fc" id="L711">            _window = window;</span>
<span class="fc" id="L712">            _url = url;</span>
<span class="fc" id="L713">        }</span>

        public void jsFunction_replace(String urlString) throws IOException, SAXException {
<span class="fc" id="L716">            _window.setLocation(urlString);</span>
<span class="fc" id="L717">        }</span>

        public String jsGet_href() {
<span class="fc" id="L720">            return toString();</span>
        }

        public void jsSet_href(String urlString) throws SAXException, IOException {
<span class="fc" id="L724">            _window.setLocation(urlString);</span>
<span class="fc" id="L725">        }</span>

        public String jsGet_protocol() {
<span class="fc" id="L728">            return _url.getProtocol() + ':';</span>
        }

        public String jsGet_host() {
<span class="fc" id="L732">            return _url.getHost() + ':' + _url.getPort();</span>
        }

        public String jsGet_hostname() {
<span class="fc" id="L736">            return _url.getHost();</span>
        }

        public String jsGet_port() {
<span class="fc" id="L740">            return String.valueOf(_url.getPort());</span>
        }

        public String jsGet_pathname() {
<span class="fc" id="L744">            return _url.getPath();</span>
        }

        public void jsSet_pathname(String newPath) throws SAXException, IOException {
<span class="pc bpc" id="L748" title="1 of 2 branches missed.">            if (!newPath.startsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L749">                newPath = '/' + newPath;</span>
            }
<span class="fc" id="L751">            URL newURL = new URL(_url, newPath);</span>
<span class="fc" id="L752">            _window.setLocation(newURL.toExternalForm());</span>
<span class="fc" id="L753">        }</span>

        public String jsGet_search() {
<span class="fc" id="L756">            return '?' + _url.getQuery();</span>
        }

        public void jsSet_search(String newSearch) throws SAXException, IOException {
<span class="pc bpc" id="L760" title="1 of 2 branches missed.">            if (!newSearch.startsWith(&quot;?&quot;)) {</span>
<span class="nc" id="L761">                newSearch = '?' + newSearch;</span>
            }
<span class="fc" id="L763">            _window.setLocation(jsGet_protocol() + &quot;//&quot; + jsGet_host() + jsGet_pathname() + newSearch);</span>
<span class="fc" id="L764">        }</span>

        /**
         * Returns the default value of this scriptable object. In this case, it returns simply the URL as a string.
         * Note that this method is necessary, since Rhino will only call the toString method directly if there are no
         * Rhino methods defined (jsGet_*, jsFunction_*, etc.)
         */
        @Override
        public Object getDefaultValue(Class typeHint) {
<span class="fc" id="L773">            return _url.toExternalForm();</span>
        }

        @Override
        public String toString() {
<span class="fc" id="L778">            return _url.toExternalForm();</span>
        }

    }

<span class="fc" id="L783">    static public class Style extends JavaScriptEngine {</span>

        private static final long serialVersionUID = 1L;
<span class="fc" id="L786">        private String _display = &quot;inline&quot;;</span>
<span class="fc" id="L787">        private String _visibility = &quot;visible&quot;;</span>

        @Override
        public String getClassName() {
<span class="fc" id="L791">            return &quot;Style&quot;;</span>
        }

        public String jsGet_display() {
<span class="fc" id="L795">            return _display;</span>
        }

        public void jsSet_display(String display) {
<span class="fc" id="L799">            _display = display;</span>
<span class="fc" id="L800">        }</span>

        public String jsGet_visibility() {
<span class="fc" id="L803">            return _visibility;</span>
        }

        public void jsSet_visibility(String visibility) {
<span class="fc" id="L807">            _visibility = visibility;</span>
<span class="fc" id="L808">        }</span>
    }

<span class="fc" id="L811">    static public class Navigator extends JavaScriptEngine {</span>

        private static final long serialVersionUID = 1L;
        private ClientProperties _clientProperties;

        @Override
        public String getClassName() {
<span class="fc" id="L818">            return &quot;Navigator&quot;;</span>
        }

        void setClientProperties(ClientProperties clientProperties) {
<span class="fc" id="L822">            _clientProperties = clientProperties;</span>
<span class="fc" id="L823">        }</span>

        public String jsGet_appName() {
<span class="fc" id="L826">            return _clientProperties.getApplicationName();</span>
        }

        public String jsGet_appCodeName() {
<span class="fc" id="L830">            return _clientProperties.getApplicationCodeName();</span>
        }

        public String jsGet_appVersion() {
<span class="fc" id="L834">            return _clientProperties.getApplicationVersion();</span>
        }

        public String jsGet_userAgent() {
<span class="fc" id="L838">            return _clientProperties.getUserAgent();</span>
        }

        public String jsGet_platform() {
<span class="fc" id="L842">            return _clientProperties.getPlatform();</span>
        }

        public Object[] jsGet_plugins() {
<span class="fc" id="L846">            return new Object[0];</span>
        }

        public boolean jsFunction_javaEnabled() {
<span class="fc" id="L850">            return false; // no support is provided for applets at present</span>
        }

    }

<span class="fc" id="L855">    static public class Screen extends JavaScriptEngine {</span>

        private static final long serialVersionUID = 1L;
        private ClientProperties _clientProperties;

        void setClientProperties(ClientProperties clientProperties) {
<span class="fc" id="L861">            _clientProperties = clientProperties;</span>
<span class="fc" id="L862">        }</span>

        @Override
        public String getClassName() {
<span class="fc" id="L866">            return &quot;Screen&quot;;</span>
        }

        public int jsGet_availWidth() {
<span class="fc" id="L870">            return _clientProperties.getAvailableScreenWidth();</span>
        }

        public int jsGet_availHeight() {
<span class="fc" id="L874">            return _clientProperties.getAvailHeight();</span>
        }

    }

    static public class ElementArray extends ScriptableObject {

        private static final long serialVersionUID = 1L;
<span class="fc" id="L882">        private JavaScriptEngine _contents[] = new HTMLElement[0];</span>

        static ElementArray newElementArray(Scriptable parent) {
            try {
<span class="fc" id="L886">                return (ElementArray) Context.getCurrentContext().newObject(parent, &quot;ElementArray&quot;);</span>
<span class="nc" id="L887">            } catch (EvaluatorException | JavaScriptException e) {</span>
<span class="nc" id="L888">                throw new RhinoException(e);</span>
            }
        }

<span class="fc" id="L892">        public ElementArray() {</span>
<span class="fc" id="L893">        }</span>

        void initialize(JavaScriptEngine[] contents) {
<span class="fc" id="L896">            _contents = contents;</span>
<span class="fc" id="L897">        }</span>

        public int jsGet_length() {
<span class="fc" id="L900">            return _contents.length;</span>
        }

        @Override
        public String getClassName() {
<span class="fc" id="L905">            return &quot;ElementArray&quot;;</span>
        }

        @Override
        public Object get(int i, Scriptable scriptable) {
<span class="pc bpc" id="L910" title="2 of 4 branches missed.">            if (i &gt;= 0 &amp;&amp; i &lt; _contents.length) {</span>
<span class="fc" id="L911">                return _contents[i];</span>
            }
<span class="nc" id="L913">            return super.get(i, scriptable);</span>
        }

        @Override
        public Object get(String name, Scriptable scriptable) {
<span class="fc bfc" id="L918" title="All 2 branches covered.">            for (JavaScriptEngine content : _contents) {</span>
<span class="fc bfc" id="L919" title="All 2 branches covered.">                if (name.equalsIgnoreCase(content.getID())) {</span>
<span class="fc" id="L920">                    return content;</span>
                }
            }
<span class="fc bfc" id="L923" title="All 2 branches covered.">            for (JavaScriptEngine content : _contents) {</span>
<span class="fc bfc" id="L924" title="All 2 branches covered.">                if (name.equalsIgnoreCase(content.getName())) {</span>
<span class="fc" id="L925">                    return content;</span>
                }
            }
<span class="fc" id="L928">            return super.get(name, scriptable);</span>
        }

        protected JavaScriptEngine[] getContents() {
<span class="nc" id="L932">            return _contents;</span>
        }
    }

    /**
     * HTML Element support for JavaScript
     */
<span class="fc" id="L939">    static public class HTMLElement extends JavaScriptEngine {</span>

        private static final long serialVersionUID = 1L;
        private Style _style;
        private Document _document;

        @Override
        public String getClassName() {
<span class="fc" id="L947">            return &quot;HTMLElement&quot;;</span>
        }

        public Document jsGet_document() {
<span class="fc" id="L951">            return _document;</span>
        }

        public Style jsGet_style() {
<span class="fc" id="L955">            return _style;</span>
        }

        /**
         * arbitrary attribute access
         *
         * @param attributeName
         *
         * @return
         */
        public Object jsFunction_getAttribute(String attributeName) {
<span class="nc" id="L966">            return _scriptable.get(attributeName);</span>
        }

        @Override
        void initialize(JavaScriptEngine parent, ScriptableDelegate scriptable)
                throws JavaScriptException, EvaluatorException, SAXException {
<span class="fc" id="L972">            super.initialize(parent, scriptable);</span>
<span class="fc" id="L973">            _document = (Document) parent;</span>
<span class="fc" id="L974">            _style = (Style) Context.getCurrentContext().newObject(this, &quot;Style&quot;);</span>
<span class="fc" id="L975">        }</span>

    }

<span class="fc" id="L979">    static public class Image extends HTMLElement {</span>

        private static final long serialVersionUID = 1L;

        @Override
        public String getClassName() {
<span class="fc" id="L985">            return &quot;Image&quot;;</span>
        }
    }

<span class="fc" id="L989">    static public class Link extends HTMLElement {</span>

        private static final long serialVersionUID = 1L;

        @Override
        public Document jsGet_document() {
<span class="fc" id="L995">            return super.jsGet_document();</span>
        }

        @Override
        public String getClassName() {
<span class="fc" id="L1000">            return &quot;Link&quot;;</span>
        }
    }

    /**
     * Form functions
     */
<span class="fc" id="L1007">    static public class Form extends HTMLElement {</span>

        private static final long serialVersionUID = 1L;
        private ElementArray _controls;

        @Override
        public String getClassName() {
<span class="fc" id="L1014">            return &quot;Form&quot;;</span>
        }

        public String jsGet_name() {
<span class="fc" id="L1018">            return getDelegate().getName();</span>
        }

        /**
         * @since FR [ 2163079 ] make form.name property mutable by Peter De Bruycker
         *
         * @param name
         */
        public void jsSet_name(String name) {
<span class="fc" id="L1027">            getDelegate().set(&quot;name&quot;, name);</span>
<span class="fc" id="L1028">        }</span>

        public String jsGet_action() {
<span class="nc" id="L1031">            return getDelegate().getAction();</span>
        }

        public void jsSet_action(String action) {
<span class="nc" id="L1035">            getDelegate().setAction(action);</span>
<span class="nc" id="L1036">        }</span>

        public Scriptable jsGet_elements() throws EvaluatorException, JavaScriptException {
<span class="fc bfc" id="L1039" title="All 2 branches covered.">            if (_controls == null) {</span>
<span class="fc" id="L1040">                initializeControls();</span>
            }
<span class="fc" id="L1042">            return _controls;</span>
        }

        public Object jsFunction_getElementsByTagName(String name) throws SAXException {
<span class="fc" id="L1046">            return toElementArray(getDelegate().getElementsByTagName(name));</span>
        }

        public void jsFunction_submit() throws IOException, SAXException {
<span class="fc" id="L1050">            getDelegate().submit();</span>
<span class="fc" id="L1051">        }</span>

        public void jsFunction_reset() throws IOException, SAXException {
<span class="fc" id="L1054">            getDelegate().reset();</span>
<span class="fc" id="L1055">        }</span>

        private void initializeControls() throws EvaluatorException, JavaScriptException {
<span class="fc" id="L1058">            ScriptableDelegate scriptables[] = getDelegate().getElementDelegates();</span>
<span class="fc" id="L1059">            Control[] controls = new Control[scriptables.length];</span>
<span class="fc bfc" id="L1060" title="All 2 branches covered.">            for (int i = 0; i &lt; controls.length; i++) {</span>
<span class="fc" id="L1061">                controls[i] = (Control) toScriptable(scriptables[i]);</span>
            }
<span class="fc" id="L1063">            _controls = (ElementArray) Context.getCurrentContext().newObject(this, &quot;ElementArray&quot;);</span>
<span class="fc" id="L1064">            _controls.initialize(controls);</span>
<span class="fc" id="L1065">        }</span>

        private WebForm.Scriptable getDelegate() {
<span class="fc" id="L1068">            return (WebForm.Scriptable) _scriptable;</span>
        }

    }

    /**
     * Javascript support for any control
     */
<span class="fc" id="L1076">    static public class Control extends JavaScriptEngine {</span>

        private static final long serialVersionUID = 1L;
        private Form _form;

        @Override
        public String getClassName() {
<span class="fc" id="L1083">            return &quot;Control&quot;;</span>
        }

        public Form jsGet_form() {
<span class="fc" id="L1087">            return _form;</span>
        }

        public void jsFunction_focus() {
<span class="nc" id="L1091">        }</span>

        public void jsFunction_select() {
<span class="nc" id="L1094">        }</span>

        /**
         * click via javascript
         *
         * @throws IOException
         * @throws SAXException
         */
        public void jsFunction_click() throws IOException, SAXException {
<span class="fc" id="L1103">            getDelegate().click();</span>
<span class="fc" id="L1104">        }</span>

        private Input getDelegate() {
<span class="fc" id="L1107">            return (Input) _scriptable;</span>
        }

        /** Support getting value of arbitrary attribute */
        public Object jsFunction_getAttribute(String attributeName) throws JavaScriptException {
<span class="fc" id="L1112">            return getDelegate().get(attributeName);</span>
        }

        /** Support getting value of arbitrary attribute */
        public void jsFunction_setAttribute(String attributeName, Object value) throws JavaScriptException {
<span class="fc" id="L1117">            getDelegate().setAttribute(attributeName, value);</span>
<span class="fc" id="L1118">        }</span>

        /** Support getting value of arbitrary attribute */
        public void jsFunction_removeAttribute(String attributeName) throws JavaScriptException {
<span class="nc" id="L1122">            getDelegate().removeAttribute(attributeName);</span>
<span class="nc" id="L1123">        }</span>

        /** Allow calling onchange() from within a JavaScript function */
        public void jsFunction_onchange() throws JavaScriptException {
<span class="fc" id="L1127">            Input myInput = this.getDelegate();</span>
<span class="fc" id="L1128">            myInput.sendOnChangeEvent();</span>
<span class="fc" id="L1129">        }</span>

        @Override
        void initialize(JavaScriptEngine parent, ScriptableDelegate scriptable)
                throws JavaScriptException, EvaluatorException, SAXException {
<span class="fc" id="L1134">            super.initialize(parent, scriptable);</span>
<span class="fc bfc" id="L1135" title="All 2 branches covered.">            if (parent instanceof Form) {</span>
<span class="fc" id="L1136">                _form = (Form) parent;</span>
            }
<span class="fc" id="L1138">        }</span>

    }

<span class="fc" id="L1142">    static public class Options extends JavaScriptEngine {</span>

        private static final long serialVersionUID = 1L;

        @Override
        public String getClassName() {
<span class="fc" id="L1148">            return &quot;Options&quot;;</span>
        }

        public int jsGet_length() {
<span class="fc" id="L1152">            return getDelegate().getLength();</span>
        }

        public void jsSet_length(int length) {
<span class="fc" id="L1156">            getDelegate().setLength(length);</span>
<span class="fc" id="L1157">        }</span>

        @Override
        public void put(int i, Scriptable scriptable, Object object) {
<span class="fc bfc" id="L1161" title="All 2 branches covered.">            if (object == null) {</span>
<span class="fc" id="L1162">                getDelegate().put(i, null);</span>
            } else {
<span class="pc bpc" id="L1164" title="1 of 2 branches missed.">                if (!(object instanceof Option)) {</span>
<span class="nc" id="L1165">                    throw new IllegalArgumentException(&quot;May only add an Option to this array&quot;);</span>
                }
<span class="fc" id="L1167">                Option option = (Option) object;</span>
<span class="fc" id="L1168">                getDelegate().put(i, option.getDelegate());</span>
            }
<span class="fc" id="L1170">        }</span>

        private SelectionOptions getDelegate() {
<span class="fc" id="L1173">            return (SelectionOptions) _scriptable;</span>
        }

    }

<span class="fc" id="L1178">    static public class Option extends JavaScriptEngine {</span>

        private static final long serialVersionUID = 1L;

        @Override
        public String getClassName() {
<span class="fc" id="L1184">            return &quot;Option&quot;;</span>
        }

        public void jsConstructor(String text, String value, boolean defaultSelected, boolean selected) {
<span class="fc" id="L1188">            _scriptable = WebResponse.newDelegate(&quot;Option&quot;);</span>
<span class="fc" id="L1189">            getDelegate().initialize(text, value, defaultSelected, selected);</span>
<span class="fc" id="L1190">        }</span>

        public int jsGet_index() {
<span class="fc" id="L1193">            return getDelegate().getIndex();</span>
        }

        public String jsGet_text() {
<span class="fc" id="L1197">            return getDelegate().getText();</span>
        }

        public void jsSet_text(String text) {
<span class="fc" id="L1201">            getDelegate().setText(text);</span>
<span class="fc" id="L1202">        }</span>

        public String jsGet_value() {
<span class="fc" id="L1205">            return getDelegate().getValue();</span>
        }

        public void jsSet_value(String value) {
<span class="fc" id="L1209">            getDelegate().setValue(value);</span>
<span class="fc" id="L1210">        }</span>

        public boolean jsGet_selected() {
<span class="fc" id="L1213">            return getDelegate().isSelected();</span>
        }

        public void jsSet_selected(boolean selected) {
<span class="fc" id="L1217">            getDelegate().setSelected(selected);</span>
<span class="fc" id="L1218">        }</span>

        public boolean jsGet_defaultSelected() {
<span class="nc" id="L1221">            return getDelegate().isDefaultSelected();</span>
        }

        SelectionOption getDelegate() {
<span class="fc" id="L1225">            return (SelectionOption) _scriptable;</span>
        }
    }

}

/**
 * special exception for the Rhino Javscript engine
 */
class RhinoException extends RuntimeException {

    private static final long serialVersionUID = 1L;
    private Exception _cause;

<span class="nc" id="L1239">    public RhinoException(Exception cause) {</span>
<span class="nc" id="L1240">        _cause = cause;</span>
<span class="nc" id="L1241">    }</span>

    @Override
    public String getMessage() {
<span class="nc" id="L1245">        return &quot;Rhino exception: &quot; + _cause;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>