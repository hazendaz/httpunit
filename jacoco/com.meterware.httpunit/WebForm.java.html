<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebForm.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">httpunit</a> &gt; <a href="index.source.html" class="el_package">com.meterware.httpunit</a> &gt; <span class="el_source">WebForm.java</span></div><h1>WebForm.java</h1><pre class="source lang-java linenums">/*
 * MIT License
 *
 * Copyright 2011-2024 Russell Gold
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated
 * documentation files (the &quot;Software&quot;), to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and
 * to permit persons to whom the Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions
 * of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO
 * THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
 * DEALINGS IN THE SOFTWARE.
 */
package com.meterware.httpunit;

import com.meterware.httpunit.protocol.ParameterProcessor;
import com.meterware.httpunit.protocol.UploadFileSpec;
import com.meterware.httpunit.scripting.FormScriptable;
import com.meterware.httpunit.scripting.IdentifiedDelegate;
import com.meterware.httpunit.scripting.NamedDelegate;
import com.meterware.httpunit.scripting.ScriptableDelegate;

import java.io.File;
import java.io.IOException;
import java.net.URL;
import java.net.UnknownServiceException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Vector;

import org.w3c.dom.Node;
import org.w3c.dom.html.HTMLCollection;
import org.w3c.dom.html.HTMLFormElement;
import org.xml.sax.SAXException;

/**
 * This class represents a form in an HTML page. Users of this class may examine the parameters defined for the form,
 * the structure of the form (as a DOM), or the text of the form. They may also create a {@link WebRequest} to simulate
 * the submission of the form.
 *
 * @author &lt;a href=&quot;mailto:russgold@httpunit.org&quot;&gt;Russell Gold&lt;/a&gt;
 **/
public class WebForm extends WebRequestSource {
<span class="fc" id="L52">    private final static String[] NO_VALUES = {};</span>

    private Button[] _buttons;

    /** The submit buttons in this form. **/
    private SubmitButton[] _submitButtons;

    /** The character set in which the form will be submitted. **/
    private String _characterSet;

    private Vector _buttonVector;

    private FormControl[] _presetParameters;
    private ArrayList _presets;

    private ElementRegistry _registry;

    /** Predicate to match a link's name. **/
    public final static HTMLElementPredicate MATCH_NAME;
    private HTMLFormElement _domElement;

    /**
     * Submits this form using the web client from which it was originally obtained.
     **/
    public WebResponse submit() throws IOException, SAXException {
<span class="fc" id="L77">        return submit(getDefaultButton());</span>
    }

    /**
     * Submits this form using the web client from which it was originally obtained. Will usually return the result of
     * that submission; however, if the submit button's 'onclick' or the form's 'onsubmit' event is triggered and
     * inhibits the submission, will return the updated contents of the frame containing this form.
     **/
    public WebResponse submit(SubmitButton button) throws IOException, SAXException {
<span class="fc" id="L86">        return submit(button, 0, 0);</span>
    }

    /**
     * Submits this form using the web client from which it was originally obtained. Will usually return the result of
     * that submission; however, if the submit button's 'onclick' or the form's 'onsubmit' event is triggered and
     * inhibits the submission, will return the updated contents of the frame containing this form.
     *
     * @since 1.6
     **/
    public WebResponse submit(SubmitButton button, int x, int y) throws IOException, SAXException {
<span class="fc bfc" id="L97" title="All 2 branches covered.">        if (button == null) {</span>
<span class="fc" id="L98">            throw new IllegalSubmitButtonException(&quot;?&quot;, &quot;?&quot;);</span>
        }
<span class="fc" id="L100">        button.doOnClickSequence(x, y);</span>
<span class="fc" id="L101">        return getCurrentFrameContents();</span>
    }

    /**
     * Submits this form using the web client from which it was originally obtained, ignoring any buttons defined for
     * the form.
     *
     * @since 1.6
     **/
    public WebResponse submitNoButton() throws SAXException, IOException {
<span class="fc" id="L111">        return submit(SubmitButton.createFakeSubmitButton(this /* fake */));</span>
    }

    @Override
    protected WebResponse submitRequest(String event, WebRequest request) throws IOException, SAXException {
        try {
<span class="fc" id="L117">            return super.submitRequest(event, request);</span>
<span class="fc" id="L118">        } catch (UnknownServiceException e) {</span>
<span class="fc" id="L119">            throw new UnsupportedActionException(</span>
<span class="fc" id="L120">                    &quot;HttpUnit does not support &quot; + request.getURL().getProtocol() + &quot; URLs in form submissions&quot;);</span>
        }
    }

    /**
     * Submits the form without also invoking the button's &quot;onclick&quot; event.
     */
    WebResponse doFormSubmit(SubmitButton button) throws IOException, SAXException {
<span class="nc" id="L128">        return submitRequest(getAttribute(&quot;onsubmit&quot;), getRequest(button));</span>
    }

    WebResponse doFormSubmit(SubmitButton button, int x, int y) throws IOException, SAXException {
<span class="fc" id="L132">        return submitRequest(getAttribute(&quot;onsubmit&quot;), getRequest(button, x, y));</span>
    }

    /**
     * Returns the method defined for this form.
     **/
    public String getMethod() {
<span class="fc" id="L139">        return getAttribute(&quot;method&quot;, &quot;GET&quot;);</span>
    }

    /**
     * Returns the action defined for this form.
     **/
    public String getAction() {
<span class="fc" id="L146">        return getDestination();</span>
    }

    /**
     * Returns true if a parameter with given name exists in this form.
     **/
    public boolean hasParameterNamed(String soughtName) {
<span class="fc" id="L153">        return getFormParameters().containsKey(soughtName);</span>
    }

    /**
     * Returns true if a parameter starting with a given name exists,
     **/
    public boolean hasParameterStartingWithPrefix(String prefix) {
<span class="fc" id="L160">        String[] names = getParameterNames();</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">        for (String name : names) {</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">            if (name.startsWith(prefix)) {</span>
<span class="fc" id="L163">                return true;</span>
            }
        }
<span class="nc" id="L166">        return false;</span>
    }

    /**
     * Returns an array containing all of the buttons defined for this form.
     **/
    public Button[] getButtons() {
<span class="fc bfc" id="L173" title="All 2 branches covered.">        if (_buttons == null) {</span>
<span class="fc" id="L174">            FormControl[] controls = getFormControls();</span>
<span class="fc" id="L175">            ArrayList buttonList = new ArrayList();</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">            for (FormControl control : controls) {</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">                if (control instanceof Button) {</span>
<span class="fc" id="L178">                    buttonList.add(control);</span>
                }
            }
<span class="fc" id="L181">            _buttons = (Button[]) buttonList.toArray(new Button[buttonList.size()]);</span>
        }
<span class="fc" id="L183">        return _buttons;</span>
    }

    public Button getButton(HTMLElementPredicate predicate, Object criteria) {
<span class="fc" id="L187">        Button[] buttons = getButtons();</span>
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">        for (Button button : buttons) {</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">            if (predicate.matchesCriteria(button, criteria)) {</span>
<span class="fc" id="L190">                return button;</span>
            }
        }
<span class="nc" id="L193">        return null;</span>
    }

    /**
     * Convenience method which returns the button with the specified ID.
     */
    public Button getButtonWithID(String buttonID) {
<span class="fc" id="L200">        return getButton(Button.WITH_ID, buttonID);</span>
    }

    /**
     * Returns an array containing the submit buttons defined for this form.
     **/
    public SubmitButton[] getSubmitButtons() {
<span class="fc bfc" id="L207" title="All 2 branches covered.">        if (_submitButtons == null) {</span>
<span class="fc" id="L208">            Vector buttons = getSubmitButtonVector();</span>
<span class="fc" id="L209">            _submitButtons = new SubmitButton[buttons.size()];</span>
<span class="fc" id="L210">            buttons.copyInto(_submitButtons);</span>
        }
<span class="fc" id="L212">        return _submitButtons;</span>
    }

    /**
     * Returns the submit button defined in this form with the specified name. If more than one such button exists, will
     * return the first found. If no such button is found, will return null.
     **/
    public SubmitButton getSubmitButton(String name) {
<span class="fc" id="L220">        SubmitButton[] buttons = getSubmitButtons();</span>
<span class="fc bfc" id="L221" title="All 2 branches covered.">        for (SubmitButton button : buttons) {</span>
<span class="fc bfc" id="L222" title="All 2 branches covered.">            if (button.getName().equals(name)) {</span>
<span class="fc" id="L223">                return button;</span>
            }
        }
<span class="fc" id="L226">        return null;</span>
    }

    /**
     * Returns the submit button defined in this form with the specified name and value. If more than one such button
     * exists, will return the first found. If no such button is found, will return null.
     **/
    public SubmitButton getSubmitButton(String name, String value) {
<span class="fc" id="L234">        SubmitButton[] buttons = getSubmitButtons();</span>
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">        for (SubmitButton button : buttons) {</span>
<span class="pc bpc" id="L236" title="1 of 4 branches missed.">            if (button.getName().equals(name) &amp;&amp; button.getValue().equals(value)) {</span>
<span class="fc" id="L237">                return button;</span>
            }
        }
<span class="nc" id="L240">        return null;</span>
    }

    /**
     * Returns the submit button defined in this form with the specified ID. If more than one such button exists, will
     * return the first found. If no such button is found, will return null.
     **/
    public SubmitButton getSubmitButtonWithID(String ID) {
<span class="fc" id="L248">        SubmitButton[] buttons = getSubmitButtons();</span>
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">        for (SubmitButton button : buttons) {</span>
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">            if (button.getID().equals(ID)) {</span>
<span class="fc" id="L251">                return button;</span>
            }
        }
<span class="nc" id="L254">        return null;</span>
    }

    /**
     * Creates and returns a web request which will simulate the submission of this form with a button with the
     * specified name and value.
     **/
    public WebRequest getRequest(String submitButtonName, String submitButtonValue) {
<span class="fc" id="L262">        SubmitButton sb = getSubmitButton(submitButtonName, submitButtonValue);</span>
<span class="pc bpc" id="L263" title="1 of 2 branches missed.">        if (sb == null) {</span>
<span class="nc" id="L264">            throw new IllegalSubmitButtonException(submitButtonName, submitButtonValue);</span>
        }
<span class="fc" id="L266">        return getRequest(sb);</span>
    }

    /**
     * Creates and returns a web request which will simulate the submission of this form with a button with the
     * specified name.
     **/
    public WebRequest getRequest(String submitButtonName) {
<span class="fc" id="L274">        SubmitButton sb = getSubmitButton(submitButtonName);</span>
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">        if (sb == null) {</span>
<span class="nc" id="L276">            throw new IllegalSubmitButtonException(submitButtonName, &quot;&quot;);</span>
        }
<span class="fc" id="L278">        return getRequest(sb);</span>
    }

    /**
     * Creates and returns a web request which will simulate the submission of this form by pressing the specified
     * button. If the button is null, simulates the pressing of the default button.
     **/
    public WebRequest getRequest(SubmitButton button) {
<span class="fc" id="L286">        return getRequest(button, 0, 0);</span>
    }

    /**
     * Creates and returns a web request which will simulate the submission of this form by pressing the specified
     * button. If the button is null, simulates the pressing of the default button.
     *
     * @param button
     *            - the submitbutton to be pressed - may be null
     * @param x
     *            - the x position
     * @param y
     *            - the y position
     **/
    public WebRequest getRequest(SubmitButton button, int x, int y) {
<span class="fc bfc" id="L301" title="All 2 branches covered.">        if (button == null) {</span>
<span class="fc" id="L302">            button = getDefaultButton();</span>
        }

<span class="fc bfc" id="L305" title="All 2 branches covered.">        if (HttpUnitOptions.getParameterValuesValidated()) {</span>
<span class="fc bfc" id="L306" title="All 2 branches covered.">            if (button == null) {</span>
<span class="fc" id="L307">                throw new IllegalUnnamedSubmitButtonException();</span>
            }
<span class="fc bfc" id="L309" title="All 2 branches covered.">            if (button.isFake()) {</span>
                // bypass checks
<span class="fc bfc" id="L311" title="All 2 branches covered.">            } else if (!getSubmitButtonVector().contains(button)) {</span>
<span class="fc" id="L312">                throw new IllegalSubmitButtonException(button);</span>
<span class="fc bfc" id="L313" title="All 2 branches covered.">            } else if (!button.wasEnabled()) {</span>
                // this is too late for the check of isDisabled()
                // onclick has already been done ...
                // [ 1289151 ] Order of events in button.click() is wrong
<span class="nc" id="L317">                button.throwDisabledException();</span>
            }
        }

<span class="fc" id="L321">        SubmitButton[] buttons = getSubmitButtons();</span>
<span class="fc bfc" id="L322" title="All 2 branches covered.">        for (SubmitButton button2 : buttons) {</span>
<span class="fc" id="L323">            button2.setPressed(false);</span>
        }
<span class="fc" id="L325">        button.setPressed(true);</span>

<span class="fc bfc" id="L327" title="All 2 branches covered.">        if (getMethod().equalsIgnoreCase(&quot;post&quot;)) {</span>
<span class="fc" id="L328">            return new PostMethodWebRequest(this, button, x, y);</span>
        }
<span class="fc" id="L330">        return new GetMethodWebRequest(this, WebRequest.newParameterHolder(this), button, x, y);</span>
    }

    /**
     * Creates and returns a web request which includes the specified button. If no button is specified, will include
     * the default button, if any. No parameter validation will be done on the returned request and no scripts will be
     * run when it is submitted.
     **/
    public WebRequest newUnvalidatedRequest(SubmitButton button) {
<span class="fc" id="L339">        return newUnvalidatedRequest(button, 0, 0);</span>
    }

    /**
     * Creates and returns a web request which includes the specified button and position. If no button is specified,
     * will include the default button, if any. No parameter validation will be done on the returned request and no
     * scripts will be run when it is submitted.
     **/
    public WebRequest newUnvalidatedRequest(SubmitButton button, int x, int y) {
<span class="fc bfc" id="L348" title="All 2 branches covered.">        if (button == null) {</span>
<span class="fc" id="L349">            button = getDefaultButton();</span>
        }

<span class="fc" id="L352">        SubmitButton[] buttons = getSubmitButtons();</span>
<span class="fc bfc" id="L353" title="All 2 branches covered.">        for (SubmitButton button2 : buttons) {</span>
<span class="fc" id="L354">            button2.setPressed(false);</span>
        }
<span class="fc" id="L356">        button.setPressed(true);</span>

<span class="fc bfc" id="L358" title="All 2 branches covered.">        if (getMethod().equalsIgnoreCase(&quot;post&quot;)) {</span>
<span class="fc" id="L359">            return new PostMethodWebRequest(this, new UncheckedParameterHolder(this), button, x, y);</span>
        }
<span class="fc" id="L361">        return new GetMethodWebRequest(this, new UncheckedParameterHolder(this), button, x, y);</span>
    }

    private WebRequest getScriptedSubmitRequest() {
<span class="fc" id="L365">        SubmitButton[] buttons = getSubmitButtons();</span>
<span class="fc bfc" id="L366" title="All 2 branches covered.">        for (SubmitButton button : buttons) {</span>
<span class="fc" id="L367">            button.setPressed(false);</span>
        }

<span class="fc bfc" id="L370" title="All 2 branches covered.">        if (getMethod().equalsIgnoreCase(&quot;post&quot;)) {</span>
<span class="fc" id="L371">            return new PostMethodWebRequest(this);</span>
        }
<span class="fc" id="L373">        return new GetMethodWebRequest(this);</span>

    }

    /**
     * Returns the default value of the named parameter. If the parameter does not exist returns null.
     **/
    public String getParameterValue(String name) {
<span class="fc" id="L381">        String[] values = getParameterValues(name);</span>
<span class="fc bfc" id="L382" title="All 2 branches covered.">        return values.length == 0 ? null : values[0];</span>
    }

    /**
     * Returns the displayed options defined for the specified parameter name.
     **/
    public String[] getOptions(String name) {
<span class="fc" id="L389">        return getParameter(name).getOptions();</span>
    }

    /**
     * Returns the option values defined for the specified parameter name.
     **/
    public String[] getOptionValues(String name) {
<span class="fc" id="L396">        return getParameter(name).getOptionValues();</span>
    }

    /**
     * Returns true if the named parameter accepts multiple values.
     **/
    public boolean isMultiValuedParameter(String name) {
<span class="nc" id="L403">        return getParameter(name).isMultiValuedParameter();</span>
    }

    /**
     * Returns the number of text parameters in this form with the specified name.
     **/
    public int getNumTextParameters(String name) {
<span class="fc" id="L410">        return getParameter(name).getNumTextParameters();</span>
    }

    /**
     * Returns true if the named parameter accepts free-form text.
     **/
    public boolean isTextParameter(String name) {
<span class="nc" id="L417">        return getParameter(name).isTextParameter();</span>
    }

    /**
     * Returns true if this form is to be submitted using mime encoding (the default is URL encoding).
     **/
    @Override
    public boolean isSubmitAsMime() {
<span class="fc" id="L425">        return &quot;multipart/form-data&quot;.equalsIgnoreCase(getAttribute(&quot;enctype&quot;));</span>
    }

    public FormScriptable getScriptableObject() {
<span class="fc" id="L429">        return (FormScriptable) getScriptingHandler();</span>
    }

    /**
     * Resets all parameters to their initial values.
     */
    public void reset() {
<span class="pc bpc" id="L436" title="1 of 2 branches missed.">        if (handleEvent(&quot;onreset&quot;)) {</span>
<span class="fc" id="L437">            resetControls();</span>
        }
<span class="fc" id="L439">    }</span>

    private void resetControls() {
<span class="fc" id="L442">        FormControl[] controls = getFormControls();</span>
<span class="fc bfc" id="L443" title="All 2 branches covered.">        for (FormControl control : controls) {</span>
<span class="fc" id="L444">            control.reset();</span>
        }
<span class="fc" id="L446">    }</span>

    @Override
    public ScriptableDelegate newScriptable() {
<span class="fc" id="L450">        return new Scriptable();</span>
    }

    // ---------------------------------- WebRequestSource methods
    // --------------------------------

    /**
     * Returns the character set encoding for this form.
     **/
    @Override
    public String getCharacterSet() {
<span class="fc" id="L461">        return _characterSet;</span>
    }

    /**
     * Returns true if the named parameter accepts files for upload.
     **/
    @Override
    public boolean isFileParameter(String name) {
<span class="fc" id="L469">        return getParameter(name).isFileParameter();</span>
    }

    /**
     * Returns an array containing the names of the parameters defined for this form.
     **/
    @Override
    public String[] getParameterNames() {
<span class="fc" id="L477">        ArrayList parameterNames = new ArrayList(getFormParameters().keySet());</span>
<span class="fc" id="L478">        return (String[]) parameterNames.toArray(new String[parameterNames.size()]);</span>
    }

    /**
     * Returns the multiple default values of the named parameter.
     **/
    @Override
    public String[] getParameterValues(String name) {
<span class="fc" id="L486">        final FormParameter parameter = getParameter(name);</span>
<span class="fc" id="L487">        return parameter.getValues();</span>
    }

    /**
     * Returns true if the named parameter is read-only. If more than one control exists with the same name, will return
     * true only if all such controls are read-only.
     **/
    public boolean isReadOnlyParameter(String name) {
<span class="fc" id="L495">        return getParameter(name).isReadOnlyParameter();</span>
    }

    /**
     * Returns true if the named parameter is disabled. If more than one control exists with the same name, will return
     * true only if all such controls are read-only.
     **/
    public boolean isDisabledParameter(String name) {
<span class="fc" id="L503">        return getParameter(name).isDisabledParameter();</span>
    }

    /**
     * Returns true if the named parameter is hidden. If more than one control exists with the same name, will return
     * true only if all such controls are hidden.
     **/
    public boolean isHiddenParameter(String name) {
<span class="fc" id="L511">        return getParameter(name).isHiddenParameter();</span>
    }

    /**
     * Creates and returns a web request which will simulate the submission of this form with an unnamed submit button.
     **/
    @Override
    public WebRequest getRequest() {
<span class="fc" id="L519">        return getRequest((SubmitButton) null);</span>
    }

    /**
     * Creates and returns a web request based on the current state of this form. No parameter validation will be done
     * and there is no guarantee over the order of parameters transmitted.
     */
    public WebRequest newUnvalidatedRequest() {
<span class="fc" id="L527">        return newUnvalidatedRequest(null);</span>
    }

    /**
     * Records a parameter defined by including it in the destination URL. Ignores any parameters whose name matches a
     * form control.
     **/
    @Override
    protected void addPresetParameter(String name, String value) {
<span class="fc" id="L536">        FormControl[] formControls = getFormControls();</span>
<span class="fc bfc" id="L537" title="All 2 branches covered.">        for (FormControl formControl : formControls) {</span>
<span class="fc bfc" id="L538" title="All 2 branches covered.">            if (formControl.getName().equals(name)) {</span>
<span class="fc" id="L539">                return;</span>
            }
        }
<span class="fc" id="L542">        _presets.add(new PresetFormParameter(this, name, value));</span>
<span class="fc" id="L543">    }</span>

    @Override
    protected String getEmptyParameterValue() {
<span class="fc" id="L547">        return null;</span>
    }

    // ---------------------------------- ParameterHolder methods
    // --------------------------------

    /**
     * Specifies the position at which an image button (if any) was clicked.
     **/
    @Override
    void selectImageButtonPosition(SubmitButton imageButton, int x, int y) {
<span class="fc" id="L558">        imageButton.setLocation(x, y);</span>
<span class="fc" id="L559">    }</span>

    /**
     * Iterates through the fixed, predefined parameters in this holder, recording them in the supplied parameter
     * processor.\ These parameters always go on the URL, no matter what encoding method is used.
     **/

    @Override
    void recordPredefinedParameters(ParameterProcessor processor) throws IOException {
<span class="fc" id="L568">        FormControl[] controls = getPresetParameters();</span>
<span class="fc bfc" id="L569" title="All 2 branches covered.">        for (FormControl control : controls) {</span>
<span class="fc" id="L570">            control.addValues(processor, getCharacterSet());</span>
        }
<span class="fc" id="L572">    }</span>

    /**
     * Iterates through the parameters in this holder, recording them in the supplied parameter processor.
     **/
    @Override
    public void recordParameters(ParameterProcessor processor) throws IOException {
<span class="fc" id="L579">        FormControl[] controls = getFormControls();</span>
<span class="fc bfc" id="L580" title="All 2 branches covered.">        for (FormControl control : controls) {</span>
<span class="fc" id="L581">            control.addValues(processor, getCharacterSet());</span>
        }
<span class="fc" id="L583">    }</span>

    /**
     * Removes a parameter name from this collection.
     **/
    @Override
    public void removeParameter(String name) {
<span class="fc" id="L590">        setParameter(name, NO_VALUES);</span>
<span class="fc" id="L591">    }</span>

    /**
     * Sets the value of a parameter in this form.
     *
     * @param name
     *            - the name of the parameter
     * @param value
     *            - the value of the parameter
     **/
    @Override
    public void setParameter(String name, String value) {
<span class="fc" id="L603">        setParameter(name, new String[] { value });</span>
<span class="fc" id="L604">    }</span>

    /**
     * Sets the multiple values of a parameter in this form. This is generally used when there are multiple controls
     * with the same name in the form.
     *
     * @param name
     * @param values
     */
    @Override
    public void setParameter(String name, final String[] values) {
<span class="fc" id="L615">        FormParameter parameter = getParameter(name);</span>
<span class="fc bfc" id="L616" title="All 2 branches covered.">        if (parameter.isUnknown()) {</span>
<span class="fc" id="L617">            throw new NoSuchParameterException(name);</span>
        }
<span class="fc bfc" id="L619" title="All 2 branches covered.">        if (parameter.isFileParameter()) {</span>
<span class="fc bfc" id="L620" title="All 2 branches covered.">            if (values != NO_VALUES) {</span>
<span class="fc" id="L621">                throw new InvalidFileParameterException(name, values);</span>
            }
<span class="fc" id="L623">            parameter.setFiles(new UploadFileSpec[0]);</span>
        } else {
<span class="fc" id="L625">            parameter.setValues(values);</span>
        }

<span class="fc" id="L628">    }</span>

    /**
     * Sets the multiple values of a file upload parameter in a web request.
     **/
    @Override
    public void setParameter(String name, UploadFileSpec[] files) {
<span class="fc" id="L635">        FormParameter parameter = getParameter(name);</span>
<span class="pc bpc" id="L636" title="1 of 4 branches missed.">        if (parameter == null || !parameter.isFileParameter()) {</span>
<span class="fc" id="L637">            throw new NoSuchParameterException(name);</span>
        }
<span class="fc" id="L639">        parameter.setFiles(files);</span>
<span class="fc" id="L640">    }</span>

    /**
     * Sets the single value of a file upload parameter in this form. A more convenient way to do this than using
     * {@link #setParameter(String,com.meterware.httpunit.protocol.UploadFileSpec[])}
     *
     * @since 1.6
     */
    public void setParameter(String name, File file) {
<span class="fc" id="L649">        setParameter(name, new UploadFileSpec[] { new UploadFileSpec(file) });</span>
<span class="fc" id="L650">    }</span>

    /**
     * Toggles the value of the specified checkbox parameter.
     *
     * @param name
     *            the name of the checkbox parameter
     *
     * @throws IllegalArgumentException
     *             if the specified parameter is not a checkbox or there is more than one control with that name.
     *
     * @since 1.5.4
     */
    public void toggleCheckbox(String name) {
<span class="fc" id="L664">        FormParameter parameter = getParameter(name);</span>
<span class="pc bpc" id="L665" title="1 of 2 branches missed.">        if (parameter == null) {</span>
<span class="nc" id="L666">            throw new NoSuchParameterException(name);</span>
        }
<span class="fc" id="L668">        parameter.toggleCheckbox();</span>
<span class="fc" id="L669">    }</span>

    /**
     * Toggles the value of the specified checkbox parameter.
     *
     * @param name
     *            the name of the checkbox parameter
     * @param value
     *            of the checkbox parameter
     *
     * @throws IllegalArgumentException
     *             if the specified parameter is not a checkbox or if there is no checkbox with the specified name and
     *             value.
     *
     * @since 1.6
     */
    public void toggleCheckbox(String name, String value) {
<span class="fc" id="L686">        FormParameter parameter = getParameter(name);</span>
<span class="pc bpc" id="L687" title="1 of 2 branches missed.">        if (parameter == null) {</span>
<span class="nc" id="L688">            throw new NoSuchParameterException(name);</span>
        }
<span class="fc" id="L690">        parameter.toggleCheckbox(value);</span>
<span class="fc" id="L691">    }</span>

    /**
     * Sets the value of the specified checkbox parameter.
     *
     * @param name
     *            the name of the checkbox parameter
     * @param state
     *            the new state of the checkbox
     *
     * @throws IllegalArgumentException
     *             if the specified parameter is not a checkbox or there is more than one control with that name.
     *
     * @since 1.5.4
     */
    public void setCheckbox(String name, boolean state) {
<span class="fc" id="L707">        FormParameter parameter = getParameter(name);</span>
<span class="pc bpc" id="L708" title="1 of 2 branches missed.">        if (parameter == null) {</span>
<span class="nc" id="L709">            throw new NoSuchParameterException(name);</span>
        }
<span class="fc" id="L711">        parameter.setValue(state);</span>
<span class="fc" id="L712">    }</span>

    /**
     * Sets the value of the specified checkbox parameter.
     *
     * @param name
     *            the name of the checkbox parameter
     * @param value
     *            of the checkbox parameter
     * @param state
     *            the new state of the checkbox
     *
     * @throws IllegalArgumentException
     *             if the specified parameter is not a checkbox or if there is no checkbox with the specified name and
     *             value.
     *
     * @since 1.6
     */
    public void setCheckbox(String name, String value, boolean state) {
<span class="fc" id="L731">        FormParameter parameter = getParameter(name);</span>
<span class="pc bpc" id="L732" title="1 of 2 branches missed.">        if (parameter == null) {</span>
<span class="nc" id="L733">            throw new NoSuchParameterException(name);</span>
        }
<span class="fc" id="L735">        parameter.setValue(value, state);</span>
<span class="fc" id="L736">    }</span>

    /**
     * Scriptable implementation for the WebForm
     */
    public class Scriptable extends HTMLElementScriptable implements NamedDelegate, IdentifiedDelegate, FormScriptable {
        public String getAction() {
<span class="fc" id="L743">            return WebForm.this.getAction();</span>
        }

        @Override
        public void setAction(String newAction) {
<span class="fc" id="L748">            setDestination(newAction);</span>
<span class="fc" id="L749">            _presetParameters = null;</span>
<span class="fc" id="L750">        }</span>

        public void submit() throws IOException, SAXException {
<span class="fc" id="L753">            submitRequest(getScriptedSubmitRequest());</span>
<span class="fc" id="L754">        }</span>

        public void reset() throws IOException, SAXException {
<span class="fc" id="L757">            resetControls();</span>
<span class="fc" id="L758">        }</span>

        /**
         * return the name of the WebForm
         *
         * @return the name
         */
        @Override
        public String getName() {
<span class="fc bfc" id="L767" title="All 2 branches covered.">            return WebForm.this.getName().length() != 0 ? WebForm.this.getName() : WebForm.this.getID();</span>
        }

        /**
         * return the id of the WebForm
         *
         * @return the id
         */
        @Override
        public String getID() {
<span class="fc" id="L777">            return WebForm.this.getID();</span>
        }

        /**
         * get the Object for the given propertyName
         *
         * @param propertyName
         *            - the name of the property to get
         *
         * @return the Object for the property
         */
        @Override
        public Object get(String propertyName) {
<span class="fc bfc" id="L790" title="All 2 branches covered.">            if (propertyName.equals(&quot;target&quot;)) {</span>
<span class="fc" id="L791">                return getTarget();</span>
            }
<span class="fc bfc" id="L793" title="All 2 branches covered.">            if (propertyName.equals(&quot;action&quot;)) {</span>
<span class="fc" id="L794">                return getAction();</span>
            }
<span class="fc bfc" id="L796" title="All 2 branches covered.">            if (propertyName.equals(&quot;length&quot;)) {</span>
<span class="fc" id="L797">                return Integer.valueOf(getFormControls().length);</span>
            }
<span class="fc" id="L799">            final FormParameter parameter = getParameter(propertyName);</span>
<span class="fc bfc" id="L800" title="All 2 branches covered.">            if (!parameter.isUnknown()) {</span>
<span class="fc" id="L801">                return parameter.getScriptableObject();</span>
            }
<span class="fc" id="L803">            FormControl control = getControlWithID(propertyName);</span>
<span class="fc bfc" id="L804" title="All 2 branches covered.">            return control == null ? super.get(propertyName) : control.getScriptingHandler();</span>
        }

        /**
         * Sets the value of the named property. Will throw a runtime exception if the property does not exist or cannot
         * accept the specified value.
         *
         * @param propertyName
         *            - the name of the property
         * @param value
         *            - the new value
         **/
        @Override
        public void set(String propertyName, Object value) {
<span class="fc bfc" id="L818" title="All 2 branches covered.">            if (propertyName.equals(&quot;target&quot;)) {</span>
<span class="fc" id="L819">                setTargetAttribute(value.toString());</span>
<span class="fc bfc" id="L820" title="All 2 branches covered.">            } else if (propertyName.equals(&quot;action&quot;)) {</span>
<span class="fc" id="L821">                setAction(value.toString());</span>
<span class="fc bfc" id="L822" title="All 2 branches covered.">            } else if (propertyName.equals(&quot;name&quot;)) {</span>
<span class="fc" id="L823">                getElement().setAttribute(&quot;name&quot;, value.toString());</span>
<span class="pc bpc" id="L824" title="1 of 2 branches missed.">            } else if (value instanceof String) {</span>
<span class="nc" id="L825">                setParameterValue(propertyName, (String) value);</span>
<span class="pc bpc" id="L826" title="1 of 2 branches missed.">            } else if (value instanceof Number) {</span>
<span class="fc" id="L827">                setParameterValue(propertyName, HttpUnitUtils.trimmedValue((Number) value));</span>
            } else {
<span class="nc" id="L829">                super.set(propertyName, value);</span>
            }
<span class="fc" id="L831">        }</span>

        @Override
        public void setParameterValue(String name, String value) {
<span class="fc" id="L835">            final Object scriptableObject = getParameter(name).getScriptableObject();</span>
<span class="pc bpc" id="L836" title="1 of 2 branches missed.">            if (scriptableObject instanceof ScriptableDelegate) {</span>
<span class="fc" id="L837">                ((ScriptableDelegate) scriptableObject).set(&quot;value&quot;, value);</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">            } else if (scriptableObject instanceof ScriptableDelegate[]) {</span>
<span class="nc" id="L839">                ((ScriptableDelegate[]) scriptableObject)[0].set(&quot;value&quot;, value);</span>
            }
<span class="fc" id="L841">        }</span>

        public ScriptableDelegate[] getElementDelegates() {
<span class="fc" id="L844">            FormControl[] controls = getFormControls();</span>
<span class="fc" id="L845">            ScriptableDelegate[] result = new ScriptableDelegate[controls.length];</span>
<span class="fc bfc" id="L846" title="All 2 branches covered.">            for (int i = 0; i &lt; result.length; i++) {</span>
<span class="fc" id="L847">                result[i] = (ScriptableDelegate) controls[i].getScriptingHandler();</span>
            }
<span class="fc" id="L849">            return result;</span>
        }

        public ScriptableDelegate[] getElementsByTagName(String name) throws SAXException {
<span class="fc" id="L853">            return getDelegates(getHTMLPage().getElementsByTagName(getElement(), name));</span>
        }

<span class="fc" id="L856">        Scriptable() {</span>
<span class="fc" id="L857">            super(WebForm.this);</span>
<span class="fc" id="L858">        }</span>
    }

    // ---------------------------------- package members
    // --------------------------------

    /**
     * Contructs a web form given the URL of its source page and the DOM extracted from that page.
     **/
    WebForm(WebResponse response, URL baseURL, Node node, FrameSelector frame, String defaultTarget,
            String characterSet, ElementRegistry registry) {
<span class="fc" id="L869">        super(response, node, baseURL, &quot;action&quot;, frame, defaultTarget);</span>
<span class="fc" id="L870">        _characterSet = characterSet;</span>
<span class="fc" id="L871">        _registry = registry;</span>
<span class="fc" id="L872">        _domElement = (HTMLFormElement) node;</span>
<span class="fc" id="L873">    }</span>

    /**
     * Returns the form control which is part of this form with the specified ID.
     */
    public FormControl getControlWithID(String id) {
<span class="fc" id="L879">        FormControl[] controls = getFormControls();</span>
<span class="fc bfc" id="L880" title="All 2 branches covered.">        for (FormControl control : controls) {</span>
<span class="fc bfc" id="L881" title="All 2 branches covered.">            if (control.getID().equals(id)) {</span>
<span class="fc" id="L882">                return control;</span>
            }
        }
<span class="fc" id="L885">        return null;</span>
    }

    // ---------------------------------- private members
    // --------------------------------

    private SubmitButton getDefaultButton() {
<span class="fc bfc" id="L892" title="All 2 branches covered.">        if (getSubmitButtons().length == 1) {</span>
<span class="fc" id="L893">            return getSubmitButtons()[0];</span>
        }
<span class="fc" id="L895">        return getSubmitButton(&quot;&quot;);</span>
    }

    /**
     * get the Vector of submit buttons - will always contain at least one button - if the original vector has none a
     * faked submit button will be added
     *
     * @return a Vector with the submit buttons
     */
    private Vector getSubmitButtonVector() {
<span class="fc bfc" id="L905" title="All 2 branches covered.">        if (_buttonVector == null) {</span>
<span class="fc" id="L906">            _buttonVector = new Vector();</span>
<span class="fc" id="L907">            FormControl[] controls = getFormControls();</span>
<span class="fc bfc" id="L908" title="All 2 branches covered.">            for (FormControl control : controls) {</span>
<span class="fc bfc" id="L909" title="All 2 branches covered.">                if (control instanceof SubmitButton) {</span>
<span class="fc" id="L910">                    SubmitButton sb = (SubmitButton) control;</span>
<span class="fc" id="L911">                    sb.rememberEnableState();</span>
<span class="fc" id="L912">                    _buttonVector.add(sb);</span>
                }
            }

            /**
             * make sure that there is always at least one submit button if none is in the Vector add a faked one
             */
<span class="fc bfc" id="L919" title="All 2 branches covered.">            if (_buttonVector.isEmpty()) {</span>
<span class="fc" id="L920">                _buttonVector.addElement(SubmitButton.createFakeSubmitButton(this));</span>
            }
        }
<span class="fc" id="L923">        return _buttonVector;</span>
    }

    private FormControl[] getPresetParameters() {
<span class="fc bfc" id="L927" title="All 2 branches covered.">        if (_presetParameters == null) {</span>
<span class="fc" id="L928">            _presets = new ArrayList();</span>
<span class="fc" id="L929">            loadDestinationParameters();</span>
<span class="fc" id="L930">            _presetParameters = (FormControl[]) _presets.toArray(new FormControl[_presets.size()]);</span>
        }
<span class="fc" id="L932">        return _presetParameters;</span>
    }

    FormControl newFormControl(Node child) {
<span class="fc" id="L936">        return FormControl.newFormParameter(this, child);</span>
    }

    /**
     * Returns an array of form parameter attributes for this form.
     **/
    private FormControl[] getFormControls() {
<span class="fc" id="L943">        HTMLCollection controlElements = _domElement.getElements();</span>
<span class="fc" id="L944">        FormControl[] controls = new FormControl[controlElements.getLength()];</span>
<span class="fc bfc" id="L945" title="All 2 branches covered.">        for (int i = 0; i &lt; controls.length; i++) {</span>
<span class="fc" id="L946">            controls[i] = getControlForNode(controlElements.item(i));</span>
        }
<span class="fc" id="L948">        return controls;</span>
    }

    private FormControl getControlForNode(Node node) {
<span class="pc bpc" id="L952" title="1 of 2 branches missed.">        if (_registry.hasNode(node)) {</span>
<span class="fc" id="L953">            return (FormControl) _registry.getRegisteredElement(node);</span>
        }
<span class="nc" id="L955">        return (FormControl) _registry.registerElement(node, newFormControl(node));</span>
    }

    /**
     * get the form parameter with the given name
     *
     * @param name
     *
     * @return the form parameter with this name
     */
    public FormParameter getParameter(String name) {
<span class="fc" id="L966">        final FormParameter parameter = (FormParameter) getFormParameters().get(name);</span>
<span class="fc bfc" id="L967" title="All 2 branches covered.">        return parameter != null ? parameter : FormParameter.getUNKNOWN_PARAMETER();</span>
    }

    /**
     * Returns a map of parameter name to form parameter objects. Each form parameter object represents the set of form
     * controls with a particular name. Unnamed parameters are ignored.
     */
    private Map getFormParameters() {
<span class="fc" id="L975">        Map formParameters = new HashMap();</span>
<span class="fc" id="L976">        loadFormParameters(formParameters, getPresetParameters());</span>
<span class="fc" id="L977">        loadFormParameters(formParameters, getFormControls());</span>
<span class="fc" id="L978">        return formParameters;</span>
    }

    private void loadFormParameters(Map formParameters, FormControl[] controls) {
<span class="fc bfc" id="L982" title="All 2 branches covered.">        for (FormControl control : controls) {</span>
<span class="fc bfc" id="L983" title="All 2 branches covered.">            if (control.getName().length() == 0) {</span>
<span class="fc" id="L984">                continue;</span>
            }
<span class="fc" id="L986">            FormParameter parameter = (FormParameter) formParameters.get(control.getName());</span>
<span class="fc bfc" id="L987" title="All 2 branches covered.">            if (parameter == null) {</span>
<span class="fc" id="L988">                parameter = new FormParameter();</span>
<span class="fc" id="L989">                formParameters.put(control.getName(), parameter);</span>
            }
<span class="fc" id="L991">            parameter.addControl(control);</span>
        }
<span class="fc" id="L993">    }</span>

    static {
<span class="fc" id="L996">        MATCH_NAME = (htmlElement, criteria) -&gt; HttpUnitUtils.matches(((WebForm) htmlElement).getName(), (String) criteria);</span>

<span class="fc" id="L998">    }</span>

    // ===========================---===== exception class
    // NoSuchParameterException =========================================

    /**
     * This exception is thrown on an attempt to set a file parameter to a non file type
     **/
    class InvalidFileParameterException extends IllegalRequestParameterException {

        private static final long serialVersionUID = 1L;
        /**
         * construct a new InvalidFileParameterException for the given parameter name and value list
         *
         * @param parameterName
         * @param values
         */
<span class="fc" id="L1015">        InvalidFileParameterException(String parameterName, String[] values) {</span>
<span class="fc" id="L1016">            _parameterName = parameterName;</span>
<span class="fc" id="L1017">            _values = values;</span>
<span class="fc" id="L1018">        }</span>

        /**
         * get the message for this exception
         */
        @Override
        public String getMessage() {
<span class="fc" id="L1025">            StringBuilder valueList = new StringBuilder();</span>
<span class="fc" id="L1026">            String delim = &quot;&quot;;</span>
<span class="fc bfc" id="L1027" title="All 2 branches covered.">            for (String _value : _values) {</span>
<span class="fc" id="L1028">                valueList.append(delim).append(&quot;'&quot;).append(_value).append(&quot;'&quot;);</span>
<span class="fc" id="L1029">                delim = &quot;, &quot;;</span>
            }
<span class="fc" id="L1031">            return &quot;The file parameter with the name '&quot; + _parameterName + &quot;' must have type File but the string values &quot; + valueList.append(&quot; where supplied&quot;).toString();</span>
        }

        private String _parameterName;
        private String[] _values;
    }

    /**
     * This exception is thrown on an attempt to set a parameter to a value not permitted to it by the form.
     **/
    class NoSuchParameterException extends IllegalRequestParameterException {

        private static final long serialVersionUID = 1L;

<span class="fc" id="L1045">        NoSuchParameterException(String parameterName) {</span>
<span class="fc" id="L1046">            _parameterName = parameterName;</span>
<span class="fc" id="L1047">        }</span>

        @Override
        public String getMessage() {
<span class="fc" id="L1051">            return &quot;No parameter named '&quot; + _parameterName + &quot;' is defined in the form&quot;;</span>
        }

        private String _parameterName;

    }

    // ============================= exception class
    // IllegalUnnamedSubmitButtonException
    // ======================================

    /**
     * This exception is thrown on an attempt to define a form request with a button not defined on that form.
     **/
    class IllegalUnnamedSubmitButtonException extends IllegalRequestParameterException {

        private static final long serialVersionUID = 1L;

<span class="fc" id="L1069">        IllegalUnnamedSubmitButtonException() {</span>
<span class="fc" id="L1070">        }</span>

        @Override
        public String getMessage() {
<span class="nc" id="L1074">            return &quot;This form has more than one submit button, none unnamed. You must specify the button to be used.&quot;;</span>
        }

    }

    // ============================= exception class
    // IllegalSubmitButtonException ======================================

    /**
     * This exception is thrown on an attempt to define a form request with a button not defined on that form.
     **/
    class IllegalSubmitButtonException extends IllegalRequestParameterException {

        private static final long serialVersionUID = 1L;
<span class="fc" id="L1088">        IllegalSubmitButtonException(SubmitButton button) {</span>
<span class="fc" id="L1089">            _name = button.getName();</span>
<span class="fc" id="L1090">            _value = button.getValue();</span>
<span class="fc" id="L1091">        }</span>

<span class="fc" id="L1093">        IllegalSubmitButtonException(String name, String value) {</span>
<span class="fc" id="L1094">            _name = name;</span>
<span class="fc" id="L1095">            _value = value;</span>
<span class="fc" id="L1096">        }</span>

        @Override
        public String getMessage() {
<span class="nc" id="L1100">            return &quot;Specified submit button (name=\&quot;&quot; + _name + &quot;\&quot; value=\&quot;&quot; + _value + &quot;\&quot;) not part of this form.&quot;;</span>
        }

        private String _name;
        private String _value;

    }

    // ============================= exception class
    // IllegalUnnamedSubmitButtonException
    // ======================================

}

// ========================================== class PresetFormParameter
// =================================================

class PresetFormParameter extends FormControl {

    PresetFormParameter(WebForm form, String name, String value) {
<span class="fc" id="L1120">        super(form);</span>
<span class="fc" id="L1121">        _name = name;</span>
<span class="fc" id="L1122">        _value = value;</span>
<span class="fc" id="L1123">    }</span>

    /**
     * Returns the name of this control..
     **/
    @Override
    public String getName() {
<span class="fc" id="L1130">        return _name;</span>
    }

    /**
     * Returns true if this control is read-only.
     **/
    @Override
    public boolean isReadOnly() {
<span class="nc" id="L1138">        return true;</span>
    }

    /**
     * Returns true if this control accepts free-form text.
     **/
    @Override
    public boolean isTextControl() {
<span class="nc" id="L1146">        return true;</span>
    }

    /**
     * Remove any required values for this control from the list, throwing an exception if they are missing.
     **/
    @Override
    void claimRequiredValues(List values) {
<span class="nc bnc" id="L1154" title="All 2 branches missed.">        if (_value != null) {</span>
<span class="nc" id="L1155">            claimValueIsRequired(values, _value);</span>
        }
<span class="nc" id="L1157">    }</span>

    @Override
    public String getType() {
<span class="nc" id="L1161">        return UNDEFINED_TYPE;</span>
    }

    /**
     * Returns the current value(s) associated with this control. These values will be transmitted to the server if the
     * control is 'successful'.
     **/
    @Override
    public String[] getValues() {
<span class="nc bnc" id="L1170" title="All 2 branches missed.">        if (_values == null) {</span>
<span class="nc" id="L1171">            _values = new String[] { _value };</span>
        }
<span class="nc" id="L1173">        return _values;</span>
    }

    @Override
    protected void addValues(ParameterProcessor processor, String characterSet) throws IOException {
<span class="fc" id="L1178">        processor.addParameter(_name, _value, characterSet);</span>
<span class="fc" id="L1179">    }</span>

    private String _name;
    private String _value;
    private String[] _values;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>