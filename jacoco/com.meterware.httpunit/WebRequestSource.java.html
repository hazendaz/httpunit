<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebRequestSource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">httpunit</a> &gt; <a href="index.source.html" class="el_package">com.meterware.httpunit</a> &gt; <span class="el_source">WebRequestSource.java</span></div><h1>WebRequestSource.java</h1><pre class="source lang-java linenums">/*
 * MIT License
 *
 * Copyright 2011-2025 Russell Gold
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated
 * documentation files (the &quot;Software&quot;), to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and
 * to permit persons to whom the Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions
 * of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO
 * THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
 * DEALINGS IN THE SOFTWARE.
 */
package com.meterware.httpunit;

import com.meterware.httpunit.scripting.ScriptableDelegate;
import com.meterware.httpunit.scripting.ScriptingHandler;

import java.io.IOException;
import java.net.URL;
import java.util.StringTokenizer;

import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.xml.sax.SAXException;

/**
 * Base class for objects which can be clicked to generate new web requests.
 */
public abstract class WebRequestSource extends ParameterHolder implements HTMLElement {

    /** The frame. */
    private FrameSelector _frame;

    /**
     * The name of the destination attribute used to create for the request, including anchors and parameters. *
     */
    private String _destinationAttribute;

    /** The scriptable. */
    private ScriptingHandler _scriptable;

    /**
     * Returns the ID associated with this request source.
     */
    @Override
    public String getID() {
<span class="fc" id="L54">        return getAttribute(&quot;id&quot;);</span>
    }

    /**
     * Returns the class associated with this request source.
     */
    @Override
    public String getClassName() {
<span class="fc" id="L62">        return getAttribute(&quot;class&quot;);</span>
    }

    /**
     * Returns the name associated with this request source.
     */
    @Override
    public String getName() {
<span class="fc" id="L70">        return getAttribute(&quot;name&quot;);</span>
    }

    /**
     * Returns the title associated with this request source.
     */
    @Override
    public String getTitle() {
<span class="fc" id="L78">        return getAttribute(&quot;title&quot;);</span>
    }

    /**
     * Returns the target for this request source.
     *
     * @return the target
     */
    public String getTarget() {
<span class="fc bfc" id="L87" title="All 2 branches covered.">        if (getSpecifiedTarget().isEmpty()) {</span>
<span class="fc" id="L88">            return _defaultTarget;</span>
        }
<span class="fc" id="L90">        return getSpecifiedTarget();</span>
    }

    /**
     * Returns the name of the frame containing this request source.
     *
     * @return the page frame
     *
     * @deprecated as of 1.6, use #getFrame
     */
    @Deprecated
    public String getPageFrame() {
<span class="nc" id="L102">        return _frame.getName();</span>
    }

    /**
     * Returns the frame containing this request source.
     *
     * @return the frame
     */
    public FrameSelector getFrame() {
<span class="fc" id="L111">        return _frame;</span>
    }

    /**
     * Returns the fragment identifier for this request source, used to identifier an element within an HTML document.
     *
     * @return the fragment identifier
     */
    public String getFragmentIdentifier() {
<span class="fc" id="L120">        final int hashIndex = getDestination().indexOf('#');</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">        if (hashIndex &lt; 0) {</span>
<span class="fc" id="L122">            return &quot;&quot;;</span>
        }
<span class="fc" id="L124">        return getDestination().substring(hashIndex + 1);</span>
    }

    /**
     * Returns a copy of the domain object model subtree associated with this entity.
     *
     * @return the DOM subtree
     */
    public Node getDOMSubtree() {
<span class="nc" id="L133">        return _node.cloneNode( /* deep */true);</span>
    }

    /**
     * Creates and returns a web request from this request source.
     *
     * @return the request
     */
    public abstract WebRequest getRequest();

    /**
     * Returns an array containing the names of any parameters to be sent on a request based on this request source.
     */
    @Override
    public abstract String[] getParameterNames();

    /**
     * Returns the values of the named parameter.
     */
    @Override
    public abstract String[] getParameterValues(String name);

    /**
     * Returns the URL relative to the current page which will handle the request.
     *
     * @return the relative page
     */
    String getRelativePage() {
<span class="fc" id="L161">        final String url = getRelativeURL();</span>
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">        if (HttpUnitUtils.isJavaScriptURL(url)) {</span>
<span class="nc" id="L163">            return url;</span>
        }
<span class="fc" id="L165">        final int questionMarkIndex = url.indexOf(&quot;?&quot;);</span>
<span class="pc bpc" id="L166" title="1 of 4 branches missed.">        if (questionMarkIndex &gt;= 1 &amp;&amp; questionMarkIndex &lt; url.length() - 1) {</span>
<span class="fc" id="L167">            return url.substring(0, questionMarkIndex);</span>
        }
<span class="fc" id="L169">        return url;</span>
    }

    /**
     * get the relative URL for a weblink change spaces to %20.
     *
     * @return the relative URL as a string
     */
    protected String getRelativeURL() {
<span class="fc" id="L178">        String result = HttpUnitUtils.encodeSpaces(HttpUnitUtils.trimFragment(getDestination()));</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">        if (result.trim().isEmpty()) {</span>
<span class="fc" id="L180">            result = getBaseURL().getFile();</span>
        }
<span class="fc" id="L182">        return result;</span>
    }

    // ----------------------------- protected members
    // ---------------------------------------------

    /**
     * Contructs a web request source.
     *
     * @param response
     *            the response from which this request source was extracted
     * @param node
     *            the DOM subtree defining this request source
     * @param baseURL
     *            the URL on which to base all releative URL requests
     * @param attribute
     *            the attribute which defines the relative URL to which requests will be directed
     * @param frame
     *            the frame
     * @param defaultTarget
     *            the default target
     */
    WebRequestSource(WebResponse response, Node node, URL baseURL, String attribute, FrameSelector frame,
<span class="fc" id="L205">            String defaultTarget) {</span>
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">        if (node == null) {</span>
<span class="nc" id="L207">            throw new IllegalArgumentException(&quot;node must not be null&quot;);</span>
        }
<span class="fc" id="L209">        _baseResponse = response;</span>
<span class="fc" id="L210">        _node = node;</span>
<span class="fc" id="L211">        _baseURL = baseURL;</span>
<span class="fc" id="L212">        _destinationAttribute = attribute;</span>
<span class="fc" id="L213">        _frame = frame;</span>
<span class="fc" id="L214">        _defaultTarget = defaultTarget;</span>
<span class="fc" id="L215">    }</span>

    /**
     * Gets the base URL.
     *
     * @return the base URL
     */
    protected URL getBaseURL() {
<span class="fc" id="L223">        return _baseURL;</span>
    }

    /**
     * get the Destination made public per FR 2836664 make WebRequestSource.getDestination() public by Dan Lipofsky
     *
     * @return the destination
     */
    public String getDestination() {
<span class="fc" id="L232">        return getElement().getAttribute(_destinationAttribute);</span>
    }

    /**
     * Sets the destination.
     *
     * @param destination
     *            the new destination
     */
    protected void setDestination(String destination) {
<span class="fc" id="L242">        getElement().setAttribute(_destinationAttribute, destination);</span>
<span class="fc" id="L243">    }</span>

    /**
     * Returns the actual DOM for this request source, not a copy.
     *
     * @return the element
     */
    protected Element getElement() {
<span class="fc" id="L251">        return (Element) _node;</span>
    }

    /**
     * Returns the HTMLPage associated with this request source.
     *
     * @return the HTML page
     *
     * @throws SAXException
     *             the SAX exception
     */
    protected HTMLPage getHTMLPage() throws SAXException {
<span class="fc" id="L263">        return _baseResponse.getReceivedPage();</span>
    }

    /**
     * Extracts any parameters specified as part of the destination URL, calling addPresetParameter for each one in the
     * order in which they are found.
     */
    protected final void loadDestinationParameters() {
<span class="fc" id="L271">        StringTokenizer st = new StringTokenizer(getParametersString(), PARAM_DELIM);</span>
<span class="fc bfc" id="L272" title="All 2 branches covered.">        while (st.hasMoreTokens()) {</span>
<span class="fc" id="L273">            stripOneParameter(st.nextToken());</span>
        }
<span class="fc" id="L275">    }</span>

    /**
     * submit the given event for the given request.
     *
     * @param event
     *            the event
     * @param request
     *            the request
     *
     * @return the response for the submitted Request
     *
     * @throws IOException
     *             Signals that an I/O exception has occurred.
     * @throws SAXException
     *             the SAX exception
     */
    protected WebResponse submitRequest(String event, final WebRequest request) throws IOException, SAXException {
<span class="fc" id="L293">        WebResponse response = null;</span>
<span class="fc bfc" id="L294" title="All 2 branches covered.">        if (doEventScript(event)) {</span>
<span class="fc" id="L295">            response = submitRequest(request);</span>
        }
<span class="fc bfc" id="L297" title="All 2 branches covered.">        if (response == null) {</span>
<span class="fc" id="L298">            response = getCurrentFrameContents();</span>
        }
<span class="fc" id="L300">        return response;</span>
    }

    /**
     * handle the event that has the given script attached by compiling the eventScript as a function and executing it
     *
     * @param eventScript
     *            - the script to use
     *
     * @deprecated since 1.7 - use doEventScript instead
     */
    @Deprecated
    @Override
    public boolean doEvent(String eventScript) {
<span class="nc" id="L314">        return doEventScript(eventScript);</span>
    }

    /**
     * optional do the event if it's defined
     *
     * @param eventScript
     *            - the script to handle
     *
     * @return whether the script was handled
     */
    @Override
    public boolean doEventScript(String eventScript) {
<span class="fc" id="L327">        return this.getScriptingHandler().doEventScript(eventScript);</span>
    }

    @Override
    public boolean handleEvent(String eventName) {
<span class="fc" id="L332">        return this.getScriptingHandler().handleEvent(eventName);</span>
    }

    /**
     * Gets the current frame contents.
     *
     * @return the current frame contents
     */
    protected WebResponse getCurrentFrameContents() {
<span class="fc" id="L341">        return getCurrentFrame(getBaseResponse().getWindow(), _frame);</span>
    }

    /**
     * Gets the current frame.
     *
     * @param window
     *            the window
     * @param pageFrame
     *            the page frame
     *
     * @return the current frame
     */
    private WebResponse getCurrentFrame(WebWindow window, FrameSelector pageFrame) {
<span class="fc bfc" id="L355" title="All 2 branches covered.">        return window.hasFrame(pageFrame) ? window.getFrameContents(pageFrame) : window.getCurrentPage();</span>
    }

    /**
     * Submits a request to the web client from which this request source was originally obtained.
     *
     * @param request
     *            the request
     *
     * @return the web response
     *
     * @throws IOException
     *             Signals that an I/O exception has occurred.
     * @throws SAXException
     *             the SAX exception
     */
    protected final WebResponse submitRequest(WebRequest request) throws IOException, SAXException {
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">        return getDestination().equals(&quot;#&quot;) ? _baseResponse : _baseResponse.getWindow().sendRequest(request);</span>
    }

    /**
     * Returns the web response containing this request source.
     *
     * @return the base response
     */
    protected final WebResponse getBaseResponse() {
<span class="fc" id="L381">        return _baseResponse;</span>
    }

    /**
     * Records a parameter defined by including it in the destination URL. The value can be null, if the parameter name
     * was not specified with an equals sign.
     *
     * @param name
     *            the name
     * @param value
     *            the value
     */
    abstract protected void addPresetParameter(String name, String value);

    /**
     * get the attribute value for the given name
     *
     * @param name
     *            - the name of the attribute to get
     */
    @Override
    public String getAttribute(final String name) {
<span class="fc" id="L403">        return NodeUtils.getNodeAttribute(_node, name);</span>
    }

    /**
     * set the attribute with the given name to the given value
     *
     * @param name
     *            - the name of the attribute
     * @param value
     *            - the value to use
     */
    @Override
    public void setAttribute(final String name, final Object value) {
<span class="nc bnc" id="L416" title="All 2 branches missed.">        NodeUtils.setNodeAttribute(getNode(), name, value == null ? null : value.toString());</span>
<span class="nc" id="L417">    }</span>

    /**
     * remove the given attribute
     *
     * @param name
     *            - the name of the attribute to remove
     */
    @Override
    public void removeAttribute(final String name) {
<span class="nc" id="L427">        NodeUtils.removeNodeAttribute(getNode(), name);</span>
<span class="nc" id="L428">    }</span>

    @Override
    public boolean isSupportedAttribute(String name) {
<span class="fc" id="L432">        return false;</span>
    }

    @Override
    public Node getNode() {
<span class="fc" id="L437">        return _node;</span>
    }

    /**
     * Returns the text value of this block.
     */
    @Override
    public String getText() {
<span class="pc bpc" id="L445" title="1 of 2 branches missed.">        if (_node == null) {</span>
<span class="nc" id="L446">            return &quot;&quot;;</span>
        }
<span class="pc bpc" id="L448" title="1 of 2 branches missed.">        if (_node.getNodeType() == Node.TEXT_NODE) {</span>
<span class="nc" id="L449">            return _node.getNodeValue().trim();</span>
        }
<span class="pc bpc" id="L451" title="1 of 2 branches missed.">        if (!_node.hasChildNodes()) {</span>
<span class="nc" id="L452">            return &quot;&quot;;</span>
        }
<span class="fc" id="L454">        return NodeUtils.asText(_node.getChildNodes()).trim();</span>
    }

    @Override
    public String getTagName() {
<span class="nc" id="L459">        return _node.getNodeName();</span>
    }

    /**
     * Gets the attribute.
     *
     * @param name
     *            the name
     * @param defaultValue
     *            the default value
     *
     * @return the attribute
     */
    String getAttribute(final String name, String defaultValue) {
<span class="fc" id="L473">        return NodeUtils.getNodeAttribute(_node, name, defaultValue);</span>
    }

    // ----------------------------- private members
    // -----------------------------------------------

    /**
     * parameter Delimiter for URL parameters bug report [ 1052037 ] Semicolon not supported as URL param delimiter asks
     * for this to be extended to &amp;;.
     *
     * @see http://www.w3.org/TR/html4/appendix/notes.html#h-B.2 section B2.2
     */
    private static final String PARAM_DELIM = &quot;&amp;&quot;;

    /** The web response containing this request source. * */
    private WebResponse _baseResponse;

    /**
     * The name of the frame in which the response containing this request source is rendered. *
     */
    private String _defaultTarget;

    /** The URL of the page containing this entity. * */
    private URL _baseURL;

    /** The DOM node representing this entity. * */
    private Node _node;

    /**
     * Gets the specified target.
     *
     * @return the specified target
     */
    private String getSpecifiedTarget() {
<span class="fc" id="L507">        return getAttribute(&quot;target&quot;);</span>
    }

    /**
     * Sets the target attribute.
     *
     * @param value
     *            the new target attribute
     */
    protected void setTargetAttribute(String value) {
<span class="fc" id="L517">        ((Element) _node).setAttribute(&quot;target&quot;, value);</span>
<span class="fc" id="L518">    }</span>

    /**
     * Gets all parameters from a URL.
     *
     * @return the parameters string
     */
    private String getParametersString() {
<span class="fc" id="L526">        String url = HttpUnitUtils.trimFragment(getDestination());</span>
<span class="fc bfc" id="L527" title="All 2 branches covered.">        if (url.trim().isEmpty()) {</span>
<span class="fc" id="L528">            url = getBaseURL().toExternalForm();</span>
        }
<span class="pc bpc" id="L530" title="1 of 2 branches missed.">        if (HttpUnitUtils.isJavaScriptURL(url)) {</span>
<span class="nc" id="L531">            return &quot;&quot;;</span>
        }
<span class="fc" id="L533">        final int questionMarkIndex = url.indexOf(&quot;?&quot;);</span>
<span class="pc bpc" id="L534" title="1 of 4 branches missed.">        if (questionMarkIndex &gt;= 1 &amp;&amp; questionMarkIndex &lt; url.length() - 1) {</span>
<span class="fc" id="L535">            return url.substring(questionMarkIndex + 1);</span>
        }
<span class="fc" id="L537">        return &quot;&quot;;</span>
    }

    /**
     * Extracts a parameter of the form &lt;name&gt;[=[&lt;value&gt;]].
     *
     * @param param
     *            the param
     */
    private void stripOneParameter(String param) {
<span class="fc" id="L547">        final int index = param.indexOf(&quot;=&quot;);</span>
<span class="fc bfc" id="L548" title="All 2 branches covered.">        String value = index &lt; 0 ? null</span>
<span class="fc bfc" id="L549" title="All 2 branches covered.">                : index == param.length() - 1 ? getEmptyParameterValue() : decode(param.substring(index + 1));</span>
<span class="fc bfc" id="L550" title="All 2 branches covered.">        String name = index &lt; 0 ? decode(param) : decode(param.substring(0, index));</span>
<span class="fc" id="L551">        addPresetParameter(name, value);</span>
<span class="fc" id="L552">    }</span>

    /**
     * Decode.
     *
     * @param string
     *            the string
     *
     * @return the string
     */
    private String decode(String string) {
<span class="fc" id="L563">        return HttpUnitUtils.decode(string, _baseResponse.getCharacterSet()).trim();</span>
    }

    /**
     * Gets the empty parameter value.
     *
     * @return the empty parameter value
     */
    abstract protected String getEmptyParameterValue();

    /**
     * Returns the scriptable delegate.
     */
    @Override
    public ScriptingHandler getScriptingHandler() {
<span class="fc bfc" id="L578" title="All 2 branches covered.">        if (_scriptable == null) {</span>
<span class="fc" id="L579">            _scriptable = HttpUnitOptions.getScriptingEngine().createHandler(this);</span>
        }
<span class="fc" id="L581">        return _scriptable;</span>
    }

    @Override
    public ScriptableDelegate getParentDelegate() {
<span class="fc" id="L586">        return getBaseResponse().getDocumentScriptable();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>