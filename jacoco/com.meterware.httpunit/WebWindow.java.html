<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebWindow.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">httpunit</a> &gt; <a href="index.source.html" class="el_package">com.meterware.httpunit</a> &gt; <span class="el_source">WebWindow.java</span></div><h1>WebWindow.java</h1><pre class="source lang-java linenums">/*
 * MIT License
 *
 * Copyright 2011-2025 Russell Gold
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated
 * documentation files (the &quot;Software&quot;), to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and
 * to permit persons to whom the Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions
 * of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO
 * THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
 * DEALINGS IN THE SOFTWARE.
 */
package com.meterware.httpunit;

import com.meterware.httpunit.scripting.ScriptingHandler;

import java.io.IOException;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.Hashtable;
import java.util.List;
import java.util.Map;

import org.xml.sax.SAXException;

/**
 * A window managed by a {@link com.meterware.httpunit.WebClient WebClient}.
 **/
public class WebWindow {

    /** The client which created this window. **/
    private WebClient _client;

    /** A map of frame names to current contents. **/
    private FrameHolder _frameContents;

    /** The name of the window, set via JavaScript. **/
<span class="fc" id="L46">    private String _name = &quot;&quot;;</span>

    /** The web response containing the reference that opened this window *. */
    private WebResponse _opener;

    /** True if this window has been closed. **/
    private boolean _closed;

    /** The Constant NO_NAME. */
    static final String NO_NAME = &quot;$$HttpUnit_Window$$_&quot;;

    /** The urls that have been encountered as redirect locations in the course of a single client-initiated request. */
    private final Map _redirects;

    /** True if seen initial request. */
<span class="fc" id="L61">    private boolean _isInitialRequest = true;</span>

    /**
     * Cache the initial client request to ensure that the _redirects structure gets reset.
     */
    private WebRequest _initialRequest;

    /**
     * Returns the web client associated with this window.
     *
     * @return the client
     */
    public WebClient getClient() {
<span class="fc" id="L74">        return _client;</span>
    }

    /**
     * Returns true if this window has been closed.
     *
     * @return true, if is closed
     */
    public boolean isClosed() {
<span class="fc" id="L83">        return _closed;</span>
    }

    /**
     * Closes this window.
     */
    public void close() {
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">        if (!_closed) {</span>
<span class="fc" id="L91">            _client.close(this);</span>
        }
<span class="fc" id="L93">        _closed = true;</span>
<span class="fc" id="L94">    }</span>

    /**
     * Returns the name of this window. Windows created through normal HTML or browser commands have empty names, but
     * JavaScript can set the name. A name may be used as a target for a request.
     *
     * @return the name
     */
    public String getName() {
<span class="fc" id="L103">        return _name;</span>
    }

    /**
     * Returns the web response that contained the script which opened this window.
     *
     * @return the opener
     */
    public WebResponse getOpener() {
<span class="fc" id="L112">        return _opener;</span>
    }

    /**
     * Submits a GET method request and returns a response.
     *
     * @param urlString
     *            the url string
     *
     * @return the response
     *
     * @throws IOException
     *             Signals that an I/O exception has occurred.
     *
     * @exception SAXException
     *                thrown if there is an error parsing the retrieved page
     */
    public WebResponse getResponse(String urlString) throws IOException, SAXException {
<span class="fc" id="L130">        return getResponse(new GetMethodWebRequest(urlString));</span>
    }

    /**
     * Submits a web request and returns a response. This is an alternate name for the getResponse method.
     *
     * @param request
     *            the request
     *
     * @return the WebResponse or null
     *
     * @throws IOException
     *             Signals that an I/O exception has occurred.
     * @throws SAXException
     *             the SAX exception
     */
    public WebResponse sendRequest(WebRequest request) throws IOException, SAXException {
<span class="fc" id="L147">        return getResponse(request);</span>
    }

    /**
     * Submits a web request and returns a response, using all state developed so far as stored in cookies as requested
     * by the server. see patch [ 1155415 ] Handle redirect instructions which can lead to a loop
     *
     * @param request
     *            the request
     *
     * @return the WebResponse or null
     *
     * @throws IOException
     *             Signals that an I/O exception has occurred.
     *
     * @exception SAXException
     *                thrown if there is an error parsing the retrieved page
     */
    public WebResponse getResponse(WebRequest request) throws IOException, SAXException {
        // Need to have some sort of ExecuteAroundMethod to ensure that the
        // redirects data structure gets cleared down upon exit - not
        // straightforward, since this could be a recursive call
<span class="fc bfc" id="L169" title="All 2 branches covered.">        if (_isInitialRequest) {</span>
<span class="fc" id="L170">            _initialRequest = request;</span>
<span class="fc" id="L171">            _isInitialRequest = false;</span>
        }

<span class="fc" id="L174">        WebResponse result = null;</span>

        try {
<span class="fc" id="L177">            final RequestContext requestContext = new RequestContext();</span>
<span class="fc" id="L178">            final WebResponse response = getSubframeResponse(request, requestContext);</span>
<span class="fc" id="L179">            requestContext.runScripts();</span>
            // javascript might replace the response in its frame
<span class="fc bfc" id="L181" title="All 2 branches covered.">            result = response == null ? null : response.getWindow().getFrameContents(response.getFrame());</span>
        } finally {
<span class="pc bpc" id="L183" title="1 of 4 branches missed.">            if (null != request &amp;&amp; request.equals(_initialRequest)) {</span>
<span class="fc" id="L184">                _redirects.clear();</span>
<span class="fc" id="L185">                _initialRequest = null;</span>
<span class="fc" id="L186">                _isInitialRequest = true;</span>
            }
        }
<span class="fc" id="L189">        return result;</span>
    }

    /**
     * get a Response from a SubFrame.
     *
     * @param request
     *            the request
     * @param requestContext
     *            the request context
     *
     * @return the WebResponse or null
     *
     * @throws IOException
     *             Signals that an I/O exception has occurred.
     * @throws SAXException
     *             the SAX exception
     */
    WebResponse getSubframeResponse(WebRequest request, RequestContext requestContext)
            throws IOException, SAXException {
<span class="fc" id="L209">        WebResponse response = getResource(request);</span>

<span class="fc bfc" id="L211" title="All 2 branches covered.">        return response == null ? null : updateWindow(request.getTarget(), response, requestContext);</span>
    }

    /**
     * Updates this web client based on a received response. This includes updating cookies and frames.
     *
     * @param requestTarget
     *            the request target
     * @param response
     *            the response
     * @param requestContext
     *            the request context
     *
     * @return the web response
     *
     * @throws IOException
     *             Signals that an I/O exception has occurred.
     * @throws SAXException
     *             the SAX exception
     */
    WebResponse updateWindow(String requestTarget, WebResponse response, RequestContext requestContext)
            throws IOException, SAXException {
<span class="fc" id="L233">        _client.updateClient(response);</span>
<span class="fc bfc" id="L234" title="All 4 branches covered.">        if (getClient().getClientProperties().isAutoRefresh() &amp;&amp; response.getRefreshRequest() != null) {</span>
<span class="fc" id="L235">            WebRequest request = response.getRefreshRequest();</span>
<span class="fc" id="L236">            return getResponse(request);</span>
        }
<span class="fc bfc" id="L238" title="All 2 branches covered.">        if (shouldFollowRedirect(response)) {</span>
<span class="fc" id="L239">            delay(HttpUnitOptions.getRedirectDelay());</span>
<span class="fc" id="L240">            return getResponse(new RedirectWebRequest(response));</span>
        }
<span class="fc" id="L242">        _client.updateFrameContents(this, requestTarget, response, requestContext);</span>
<span class="fc" id="L243">        return response;</span>
    }

    /**
     * Returns the resource specified by the request. Does not update the window or load included framesets. May return
     * null if the resource is a JavaScript URL which would normally leave the client unchanged.
     *
     * @param request
     *            the request
     *
     * @return the resource
     *
     * @throws IOException
     *             Signals that an I/O exception has occurred.
     */
    public WebResponse getResource(WebRequest request) throws IOException {
<span class="fc" id="L259">        _client.tellListeners(request);</span>

<span class="fc" id="L261">        WebResponse response = null;</span>
<span class="fc" id="L262">        String urlString = request.getURLString().trim();</span>
<span class="fc" id="L263">        FrameSelector targetFrame = _frameContents.getTargetFrame(request);</span>
<span class="fc bfc" id="L264" title="All 2 branches covered.">        if (urlString.startsWith(&quot;about:&quot;)) {</span>
<span class="fc" id="L265">            response = new DefaultWebResponse(_client, targetFrame, null, &quot;&quot;);</span>
<span class="fc bfc" id="L266" title="All 2 branches covered.">        } else if (!HttpUnitUtils.isJavaScriptURL(urlString)) {</span>
<span class="fc" id="L267">            response = _client.createResponse(request, targetFrame);</span>
        } else {
<span class="fc" id="L269">            ScriptingHandler handler = request.getSourceScriptingHandler();</span>
<span class="pc bpc" id="L270" title="1 of 2 branches missed.">            if (handler == null) {</span>
<span class="fc" id="L271">                handler = getCurrentPage().getScriptingHandler();</span>
            }
<span class="fc" id="L273">            Object result = handler.evaluateExpression(urlString);</span>
<span class="fc bfc" id="L274" title="All 2 branches covered.">            if (result != null) {</span>
<span class="fc" id="L275">                response = new DefaultWebResponse(_client, targetFrame, request.getURL(), result.toString());</span>
            }
        }

<span class="fc bfc" id="L279" title="All 2 branches covered.">        if (response != null) {</span>
<span class="fc" id="L280">            _client.tellListeners(response);</span>
        }
<span class="fc" id="L282">        return response;</span>
    }

    /**
     * Returns the name of the currently active frames.
     *
     * @return the frame names
     */
    public String[] getFrameNames() {
<span class="fc" id="L291">        final List&lt;String&gt; names = _frameContents.getActiveFrameNames();</span>
<span class="fc" id="L292">        return names.toArray(new String[names.size()]);</span>
    }

    /**
     * Returns true if the specified frame name is defined in this window.
     *
     * @param frameName
     *            the frame name
     *
     * @return true, if successful
     */
    public boolean hasFrame(String frameName) {
<span class="nc bnc" id="L304" title="All 2 branches missed.">        return _frameContents.get(frameName) != null;</span>
    }

    /**
     * Checks for frame.
     *
     * @param frame
     *            the frame
     *
     * @return true, if successful
     */
    boolean hasFrame(FrameSelector frame) {
<span class="fc bfc" id="L316" title="All 2 branches covered.">        return _frameContents.get(frame) != null;</span>
    }

    /**
     * Returns the response associated with the specified frame name. Throws a runtime exception if no matching frame is
     * defined.
     *
     * @param frameName
     *            the frame name
     *
     * @return the frame contents
     */
    public WebResponse getFrameContents(String frameName) {
<span class="fc" id="L329">        WebResponse response = _frameContents.get(frameName);</span>
<span class="pc bpc" id="L330" title="1 of 2 branches missed.">        if (response == null) {</span>
<span class="nc" id="L331">            throw new NoSuchFrameException(frameName);</span>
        }
<span class="fc" id="L333">        return response;</span>
    }

    /**
     * Returns the response associated with the specified frame target. Throws a runtime exception if no matching frame
     * is defined.
     *
     * @param targetFrame
     *            the target frame
     *
     * @return the frame contents
     */
    WebResponse getFrameContents(FrameSelector targetFrame) {
<span class="fc" id="L346">        return _frameContents.getFrameContents(targetFrame);</span>
    }

    /**
     * Gets the subframe contents.
     *
     * @param frame
     *            the frame
     * @param subFrameName
     *            the sub frame name
     *
     * @return the subframe contents
     */
    WebResponse getSubframeContents(FrameSelector frame, String subFrameName) {
<span class="fc" id="L360">        return _frameContents.getSubframeContents(frame, subFrameName);</span>
    }

    /**
     * Gets the parent frame contents.
     *
     * @param frame
     *            the frame
     *
     * @return the parent frame contents
     */
    WebResponse getParentFrameContents(FrameSelector frame) {
<span class="fc" id="L372">        return _frameContents.getParentFrameContents(frame);</span>
    }

    /**
     * Returns the response representing the main page in this window.
     *
     * @return the current page
     */
    public WebResponse getCurrentPage() {
<span class="fc" id="L381">        return getFrameContents(WebRequest.TOP_FRAME);</span>
    }

    /**
     * construct a WebWindow from a given client.
     *
     * @param client
     *            - the client to construct me from
     */
<span class="fc" id="L390">    WebWindow(WebClient client) {</span>
<span class="fc" id="L391">        _client = client;</span>
<span class="fc" id="L392">        _frameContents = new FrameHolder(this);</span>
<span class="fc" id="L393">        _name = NO_NAME + _client.getOpenWindows().length;</span>
<span class="fc" id="L394">        _redirects = new Hashtable&lt;&gt;();</span>
<span class="fc" id="L395">    }</span>

    /**
     * Instantiates a new web window.
     *
     * @param client
     *            the client
     * @param opener
     *            the opener
     */
    WebWindow(WebClient client, WebResponse opener) {
<span class="fc" id="L406">        this(client);</span>
<span class="fc" id="L407">        _opener = opener;</span>
<span class="fc" id="L408">    }</span>

    /**
     * Update frame contents.
     *
     * @param response
     *            the response
     * @param requestContext
     *            the request context
     *
     * @throws IOException
     *             Signals that an I/O exception has occurred.
     * @throws SAXException
     *             the SAX exception
     */
    void updateFrameContents(WebResponse response, RequestContext requestContext) throws IOException, SAXException {
<span class="fc" id="L424">        response.setWindow(this);</span>
<span class="fc" id="L425">        _frameContents.updateFrames(response, response.getFrame(), requestContext);</span>
<span class="fc" id="L426">    }</span>

    /**
     * Sets the name.
     *
     * @param name
     *            the new name
     */
    void setName(String name) {
<span class="fc" id="L435">        _name = name;</span>
<span class="fc" id="L436">    }</span>

    /**
     * Delays the specified amount of time.
     *
     * @param numMilliseconds
     *            the num milliseconds
     */
    private void delay(int numMilliseconds) {
<span class="pc bpc" id="L445" title="1 of 2 branches missed.">        if (numMilliseconds == 0) {</span>
<span class="fc" id="L446">            return;</span>
        }
        try {
<span class="nc" id="L449">            Thread.sleep(numMilliseconds);</span>
<span class="nc" id="L450">        } catch (InterruptedException e) {</span>
            // ignore the exception
<span class="nc" id="L452">            Thread.interrupted();</span>
<span class="nc" id="L453">        }</span>
<span class="nc" id="L454">    }</span>

    /**
     * check whether redirect is configured.
     *
     * @param response
     *            the response
     *
     * @return true, if successful
     */
    private boolean redirectConfigured(WebResponse response) {
<span class="fc" id="L465">        boolean isAutoredirect = getClient().getClientProperties().isAutoRedirect();</span>
<span class="fc bfc" id="L466" title="All 2 branches covered.">        boolean hasLocation = response.getHeaderField(&quot;Location&quot;) != null;</span>
<span class="fc" id="L467">        int responseCode = response.getResponseCode();</span>
<span class="pc bpc" id="L468" title="1 of 8 branches missed.">        return isAutoredirect &amp;&amp; responseCode &gt;= HttpURLConnection.HTTP_MOVED_PERM</span>
                &amp;&amp; responseCode &lt;= HttpURLConnection.HTTP_MOVED_TEMP &amp;&amp; hasLocation;
    }

    /**
     * check wether we should follow the redirect given in the response make sure we don't run into a recursion.
     *
     * @param response
     *            the response
     *
     * @return true, if successful
     */
    private boolean shouldFollowRedirect(WebResponse response) {
        // first check whether redirect is configured for this response
        // this is the old pre [ 1155415 ] Handle redirect instructions which can lead to a loop
        // shouldFollowRedirect method - just renamed
<span class="fc bfc" id="L484" title="All 2 branches covered.">        if (!redirectConfigured(response)) {</span>
<span class="fc" id="L485">            return false;</span>
        }
        // now do the recursion check
<span class="fc" id="L488">        String redirectLocation = response.getHeaderField(&quot;Location&quot;);</span>

<span class="fc" id="L490">        URL url = null;</span>

        try {
<span class="pc bpc" id="L493" title="1 of 2 branches missed.">            if (redirectLocation != null) {</span>
<span class="fc" id="L494">                url = new URL(response.getURL(), redirectLocation);</span>
            }
<span class="fc" id="L496">        } catch (MalformedURLException e) {</span>
            // Fall through and allow existing exception handling code deal
            // with any exception - we don't know at this stage whether it is
            // a redirect instruction, although it is highly likely, given
            // there is a location header present in the response!
<span class="fc" id="L501">        }</span>

<span class="pc bpc" id="L503" title="1 of 2 branches missed.">        switch (response.getResponseCode()) {</span>
            case HttpURLConnection.HTTP_MOVED_PERM:
            case HttpURLConnection.HTTP_MOVED_TEMP: // Fall through
<span class="fc" id="L506">                int count = 0;</span>
<span class="fc bfc" id="L507" title="All 2 branches covered.">                if (null != url) {</span>
<span class="fc" id="L508">                    Integer value = (Integer) _redirects.get(url);</span>
<span class="fc bfc" id="L509" title="All 2 branches covered.">                    if (null != value) {</span>
                        // We have already been instructed to redirect to that
                        // location in the course of this attempt to resolve the
                        // resource

<span class="fc" id="L514">                        count = value.intValue();</span>

<span class="fc" id="L516">                        int maxRedirects = getClient().getClientProperties().getMaxRedirects();</span>

<span class="fc bfc" id="L518" title="All 2 branches covered.">                        if (count == maxRedirects) {</span>
<span class="fc" id="L519">                            throw new RecursiveRedirectionException(url, &quot;Maximum number of redirects exceeded&quot;);</span>
                        }
                    }

<span class="fc" id="L523">                    count++;</span>
<span class="fc" id="L524">                    _redirects.put(url, Integer.valueOf(count));</span>
                }
                break;
        }
<span class="pc bpc" id="L528" title="1 of 2 branches missed.">        return redirectLocation != null;</span>
    }

    /**
     * Gets the top frame.
     *
     * @return the top frame
     */
    FrameSelector getTopFrame() {
<span class="fc" id="L537">        return _frameContents.getTopFrame();</span>
    }

    /**
     * Gets the frame.
     *
     * @param target
     *            the target
     *
     * @return the frame
     */
    FrameSelector getFrame(String target) {
<span class="fc" id="L549">        return _frameContents.getFrame(target);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>