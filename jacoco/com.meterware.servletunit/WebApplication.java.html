<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebApplication.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">httpunit</a> &gt; <a href="index.source.html" class="el_package">com.meterware.servletunit</a> &gt; <span class="el_source">WebApplication.java</span></div><h1>WebApplication.java</h1><pre class="source lang-java linenums">/*
 * MIT License
 *
 * Copyright 2011-2025 Russell Gold
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated
 * documentation files (the &quot;Software&quot;), to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and
 * to permit persons to whom the Software is furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions
 * of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO
 * THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
 * DEALINGS IN THE SOFTWARE.
 */
package com.meterware.servletunit;

import com.meterware.httpunit.HttpInternalErrorException;
import com.meterware.httpunit.HttpNotFoundException;
import com.meterware.httpunit.HttpUnitUtils;

import java.io.File;
import java.io.IOException;
import java.lang.reflect.InvocationTargetException;
import java.net.MalformedURLException;
import java.net.URL;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Dictionary;
import java.util.HashMap;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.List;
import java.util.ListIterator;
import java.util.Map;

import javax.servlet.Filter;
import javax.servlet.Servlet;
import javax.servlet.ServletContext;
import javax.servlet.ServletContextAttributeEvent;
import javax.servlet.ServletContextAttributeListener;
import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import javax.servlet.http.HttpSessionAttributeListener;
import javax.servlet.http.HttpSessionBindingEvent;
import javax.servlet.http.HttpSessionEvent;
import javax.servlet.http.HttpSessionListener;

import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.NodeList;
import org.xml.sax.SAXException;

/**
 * This class represents the information recorded about a single web application. It is usually extracted from web.xml.
 **/
class WebApplication implements SessionListenerDispatcher {

    /** The Constant NULL_SECURITY_CONSTRAINT. */
<span class="fc" id="L71">    private static final SecurityConstraint NULL_SECURITY_CONSTRAINT = new NullSecurityConstraint();</span>

    /** The security check configuration. */
<span class="fc" id="L74">    private final ServletConfiguration SECURITY_CHECK_CONFIGURATION = new ServletConfiguration(</span>
<span class="fc" id="L75">            SecurityCheckServlet.class.getName());</span>

    /** The security check mapping. */
<span class="fc" id="L78">    private final WebResourceMapping SECURITY_CHECK_MAPPING = new WebResourceMapping(SECURITY_CHECK_CONFIGURATION);</span>

    /** A mapping of resource names to servlet configurations. **/
<span class="fc" id="L81">    private WebResourceMap _servletMapping = new WebResourceMap();</span>

    /** A mapping of filter names to FilterConfigurations. */
<span class="fc" id="L84">    private Hashtable _filters = new Hashtable&lt;&gt;();</span>

    /** A mapping of servlet names to ServletConfigurations. */
<span class="fc" id="L87">    private Hashtable _servlets = new Hashtable&lt;&gt;();</span>

    /** A mapping of resource names to filter configurations. **/
<span class="fc" id="L90">    private FilterUrlMap _filterUrlMapping = new FilterUrlMap();</span>

    /** A mapping of servlet names to filter configurations. **/
<span class="fc" id="L93">    private Hashtable _filterMapping = new Hashtable&lt;&gt;();</span>

    /** The security constraints. */
<span class="fc" id="L96">    private List&lt;SecurityConstraint&gt; _securityConstraints = new ArrayList&lt;&gt;();</span>

    /** The context listeners. */
<span class="fc" id="L99">    private List&lt;ServletContextListener&gt; _contextListeners = new ArrayList&lt;&gt;();</span>

    /** The context attribute listeners. */
<span class="fc" id="L102">    private List&lt;ServletContextAttributeListener&gt; _contextAttributeListeners = new ArrayList&lt;&gt;();</span>

    /** The session listeners. */
<span class="fc" id="L105">    private List&lt;HttpSessionListener&gt; _sessionListeners = new ArrayList&lt;&gt;();</span>

    /** The session attribute listeners. */
<span class="fc" id="L108">    private List&lt;HttpSessionAttributeListener&gt; _sessionAttributeListeners = new ArrayList&lt;&gt;();</span>

    /** The use basic authentication. */
    private boolean _useBasicAuthentication;

    /** The use form authentication. */
    private boolean _useFormAuthentication;

    /** The authentication realm. */
<span class="fc" id="L117">    private String _authenticationRealm = &quot;&quot;;</span>

    /** The login URL. */
    private URL _loginURL;

    /** The error URL. */
    private URL _errorURL;

    /** The context parameters. */
<span class="fc" id="L126">    private Hashtable _contextParameters = new Hashtable&lt;&gt;();</span>

    /** The context dir. */
<span class="fc" id="L129">    private File _contextDir = null;</span>

    /** The context path. */
<span class="fc" id="L132">    private String _contextPath = null;</span>

    /** The servlet context. */
    private ServletUnitServletContext _servletContext;

    /** The display name. */
    private String _displayName;

    /**
     * Constructs a default application spec with no information.
     */
<span class="fc" id="L143">    WebApplication() {</span>
<span class="fc" id="L144">        _contextPath = &quot;&quot;;</span>
<span class="fc" id="L145">    }</span>

    /**
     * Constructs an application spec from an XML document.
     *
     * @param document
     *            the document
     *
     * @throws MalformedURLException
     *             the malformed URL exception
     * @throws SAXException
     *             the SAX exception
     */
    WebApplication(Document document) throws MalformedURLException, SAXException {
<span class="fc" id="L159">        this(document, null, &quot;&quot;);</span>
<span class="fc" id="L160">    }</span>

    /**
     * Constructs an application spec from an XML document.
     *
     * @param document
     *            the document
     * @param contextPath
     *            the context path
     *
     * @throws MalformedURLException
     *             the malformed URL exception
     * @throws SAXException
     *             the SAX exception
     */
    WebApplication(Document document, String contextPath) throws MalformedURLException, SAXException {
<span class="fc" id="L176">        this(document, null, contextPath);</span>
<span class="fc" id="L177">    }</span>

    /**
     * Constructs an application spec from an XML document.
     *
     * @param document
     *            the document
     * @param file
     *            the file
     * @param contextPath
     *            the context path
     *
     * @throws MalformedURLException
     *             the malformed URL exception
     * @throws SAXException
     *             the SAX exception
     */
<span class="fc" id="L194">    WebApplication(Document document, File file, String contextPath) throws MalformedURLException, SAXException {</span>
<span class="pc bpc" id="L195" title="1 of 6 branches missed.">        if (contextPath != null &amp;&amp; !contextPath.isEmpty() &amp;&amp; !contextPath.startsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L196">            throw new IllegalArgumentException(&quot;Context path &quot; + contextPath + &quot; must start with '/'&quot;);</span>
        }
<span class="fc" id="L198">        _contextDir = file;</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">        _contextPath = contextPath == null ? &quot;&quot; : contextPath;</span>
<span class="fc" id="L200">        NodeList nl = document.getElementsByTagName(&quot;display-name&quot;);</span>
<span class="fc bfc" id="L201" title="All 2 branches covered.">        if (nl.getLength() &gt; 0) {</span>
<span class="fc" id="L202">            _displayName = XMLUtils.getTextValue(nl.item(0)).trim();</span>
        }

<span class="fc" id="L205">        registerServlets(document);</span>
<span class="fc" id="L206">        registerFilters(document);</span>
<span class="fc" id="L207">        extractSecurityConstraints(document);</span>
<span class="fc" id="L208">        extractContextParameters(document);</span>
<span class="fc" id="L209">        extractLoginConfiguration(document);</span>
<span class="fc" id="L210">        extractListeners(document);</span>
<span class="fc" id="L211">        notifyContextInitialized();</span>
<span class="fc" id="L212">        _servletMapping.autoLoadServlets();</span>
<span class="fc" id="L213">    }</span>

    /**
     * Extract listeners.
     *
     * @param document
     *            the document
     *
     * @throws SAXException
     *             the SAX exception
     */
    private void extractListeners(Document document) throws SAXException {
<span class="fc" id="L225">        NodeList nl = document.getElementsByTagName(&quot;listener&quot;);</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">        for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="fc" id="L227">            String listenerName = XMLUtils.getChildNodeValue((Element) nl.item(i), &quot;listener-class&quot;).trim();</span>
            try {
<span class="fc" id="L229">                Object listener = Class.forName(listenerName).getDeclaredConstructor().newInstance();</span>

<span class="fc bfc" id="L231" title="All 2 branches covered.">                if (listener instanceof ServletContextListener) {</span>
<span class="fc" id="L232">                    _contextListeners.add((ServletContextListener) listener);</span>
                }
<span class="fc bfc" id="L234" title="All 2 branches covered.">                if (listener instanceof ServletContextAttributeListener) {</span>
<span class="fc" id="L235">                    _contextAttributeListeners.add((ServletContextAttributeListener) listener);</span>
                }
<span class="fc bfc" id="L237" title="All 2 branches covered.">                if (listener instanceof HttpSessionListener) {</span>
<span class="fc" id="L238">                    _sessionListeners.add((HttpSessionListener) listener);</span>
                }
<span class="fc bfc" id="L240" title="All 2 branches covered.">                if (listener instanceof HttpSessionAttributeListener) {</span>
<span class="fc" id="L241">                    _sessionAttributeListeners.add((HttpSessionAttributeListener) listener);</span>
                }
<span class="nc" id="L243">            } catch (Throwable e) {</span>
<span class="nc" id="L244">                throw new RuntimeException(&quot;Unable to load context listener &quot; + listenerName + &quot;: &quot; + e.toString());</span>
<span class="fc" id="L245">            }</span>
        }
<span class="fc" id="L247">    }</span>

    /**
     * Notify context initialized.
     */
    private void notifyContextInitialized() {
<span class="fc" id="L253">        ServletContextEvent event = new ServletContextEvent(getServletContext());</span>

<span class="fc bfc" id="L255" title="All 2 branches covered.">        for (Iterator&lt;ServletContextListener&gt; i = _contextListeners.iterator(); i.hasNext();) {</span>
<span class="fc" id="L256">            ServletContextListener listener = i.next();</span>
<span class="fc" id="L257">            listener.contextInitialized(event);</span>
<span class="fc" id="L258">        }</span>
<span class="fc" id="L259">    }</span>

    /**
     * Shut down.
     */
    void shutDown() {
<span class="fc" id="L265">        destroyServlets();</span>
<span class="fc" id="L266">        notifyContextDestroyed();</span>
<span class="fc" id="L267">    }</span>

    /**
     * Notify context destroyed.
     */
    private void notifyContextDestroyed() {
<span class="fc" id="L273">        ServletContextEvent event = new ServletContextEvent(getServletContext());</span>

<span class="fc" id="L275">        for (ListIterator&lt;ServletContextListener&gt; i = _contextListeners.listIterator(_contextListeners.size()); i</span>
<span class="fc bfc" id="L276" title="All 2 branches covered.">                .hasPrevious();) {</span>
<span class="fc" id="L277">            ServletContextListener listener = i.previous();</span>
<span class="fc" id="L278">            listener.contextDestroyed(event);</span>
<span class="fc" id="L279">        }</span>
<span class="fc" id="L280">    }</span>

    /**
     * Send attribute added.
     *
     * @param name
     *            the name
     * @param value
     *            the value
     */
    void sendAttributeAdded(String name, Object value) {
<span class="fc" id="L291">        ServletContextAttributeEvent event = new ServletContextAttributeEvent(getServletContext(), name, value);</span>

<span class="fc bfc" id="L293" title="All 2 branches covered.">        for (Iterator&lt;ServletContextAttributeListener&gt; i = _contextAttributeListeners.iterator(); i.hasNext();) {</span>
<span class="fc" id="L294">            ServletContextAttributeListener listener = i.next();</span>
<span class="fc" id="L295">            listener.attributeAdded(event);</span>
<span class="fc" id="L296">        }</span>
<span class="fc" id="L297">    }</span>

    /**
     * Send attribute replaced.
     *
     * @param name
     *            the name
     * @param value
     *            the value
     */
    void sendAttributeReplaced(String name, Object value) {
<span class="fc" id="L308">        ServletContextAttributeEvent event = new ServletContextAttributeEvent(getServletContext(), name, value);</span>

<span class="fc bfc" id="L310" title="All 2 branches covered.">        for (Iterator&lt;ServletContextAttributeListener&gt; i = _contextAttributeListeners.iterator(); i.hasNext();) {</span>
<span class="fc" id="L311">            ServletContextAttributeListener listener = i.next();</span>
<span class="fc" id="L312">            listener.attributeReplaced(event);</span>
<span class="fc" id="L313">        }</span>
<span class="fc" id="L314">    }</span>

    /**
     * Send attribute removed.
     *
     * @param name
     *            the name
     * @param value
     *            the value
     */
    void sendAttributeRemoved(String name, Object value) {
<span class="fc" id="L325">        ServletContextAttributeEvent event = new ServletContextAttributeEvent(getServletContext(), name, value);</span>

<span class="fc bfc" id="L327" title="All 2 branches covered.">        for (Iterator&lt;ServletContextAttributeListener&gt; i = _contextAttributeListeners.iterator(); i.hasNext();) {</span>
<span class="fc" id="L328">            ServletContextAttributeListener listener = i.next();</span>
<span class="fc" id="L329">            listener.attributeRemoved(event);</span>
<span class="fc" id="L330">        }</span>
<span class="fc" id="L331">    }</span>

    /**
     * Extract security constraints.
     *
     * @param document
     *            the document
     *
     * @throws SAXException
     *             the SAX exception
     */
    private void extractSecurityConstraints(Document document) throws SAXException {
<span class="fc" id="L343">        NodeList nl = document.getElementsByTagName(&quot;security-constraint&quot;);</span>
<span class="fc bfc" id="L344" title="All 2 branches covered.">        for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="fc" id="L345">            _securityConstraints.add(new SecurityConstraintImpl((Element) nl.item(i)));</span>
        }
<span class="fc" id="L347">    }</span>

    /**
     * Gets the context path.
     *
     * @return the context path
     */
    String getContextPath() {
<span class="fc" id="L355">        return _contextPath;</span>
    }

    /**
     * Gets the servlet context.
     *
     * @return the servlet context
     */
    ServletContext getServletContext() {
<span class="fc bfc" id="L364" title="All 2 branches covered.">        if (_servletContext == null) {</span>
<span class="fc" id="L365">            _servletContext = new ServletUnitServletContext(this);</span>
        }
<span class="fc" id="L367">        return _servletContext;</span>
    }

    /**
     * Registers a servlet class to be run.
     *
     * @param resourceName
     *            the resource name
     * @param servletClassName
     *            the servlet class name
     * @param initParams
     *            the init params
     */
    void registerServlet(String resourceName, String servletClassName, Hashtable initParams) {
<span class="fc" id="L381">        registerServlet(resourceName, new ServletConfiguration(servletClassName, initParams));</span>
<span class="fc" id="L382">    }</span>

    /**
     * Registers a servlet to be run.
     *
     * @param resourceName
     *            the resource name
     * @param servletConfiguration
     *            the servlet configuration
     */
    void registerServlet(String resourceName, ServletConfiguration servletConfiguration) {
        // FIXME - shouldn't everything start with one or the other?
<span class="fc bfc" id="L394" title="All 4 branches covered.">        if (!resourceName.startsWith(&quot;/&quot;) &amp;&amp; !resourceName.startsWith(&quot;*&quot;)) {</span>
<span class="fc" id="L395">            resourceName = &quot;/&quot; + resourceName;</span>
        }
<span class="fc" id="L397">        _servletMapping.put(resourceName, servletConfiguration);</span>
<span class="fc" id="L398">    }</span>

    /**
     * Calls the destroy method for every active servlet.
     */
    void destroyServlets() {
<span class="fc" id="L404">        _servletMapping.destroyWebResources();</span>
<span class="fc" id="L405">    }</span>

    /**
     * Gets the servlet request.
     *
     * @param url
     *            the url
     *
     * @return the servlet request
     */
    ServletMetaData getServletRequest(URL url) {
<span class="fc" id="L416">        return _servletMapping.get(url);</span>
    }

    /**
     * Returns true if this application uses Basic Authentication.
     *
     * @return true, if successful
     */
    boolean usesBasicAuthentication() {
<span class="fc" id="L425">        return _useBasicAuthentication;</span>
    }

    /**
     * Returns true if this application uses form-based authentication.
     *
     * @return true, if successful
     */
    boolean usesFormAuthentication() {
<span class="fc" id="L434">        return _useFormAuthentication;</span>
    }

    /**
     * Gets the authentication realm.
     *
     * @return the authentication realm
     */
    String getAuthenticationRealm() {
<span class="fc" id="L443">        return _authenticationRealm;</span>
    }

    /**
     * Gets the login URL.
     *
     * @return the login URL
     */
    URL getLoginURL() {
<span class="fc" id="L452">        return _loginURL;</span>
    }

    /**
     * Gets the error URL.
     *
     * @return the error URL
     */
    URL getErrorURL() {
<span class="fc" id="L461">        return _errorURL;</span>
    }

    /**
     * Returns true if the specified path may only be accesses by an authorized user.
     *
     * @param url
     *            the application-relative path of the URL
     *
     * @return true, if successful
     */
    boolean requiresAuthorization(URL url) {
        String result;
<span class="fc" id="L474">        String file = url.getFile();</span>
<span class="fc bfc" id="L475" title="All 2 branches covered.">        if (_contextPath.equals(&quot;&quot;)) {</span>
<span class="fc" id="L476">            result = file;</span>
<span class="pc bpc" id="L477" title="1 of 2 branches missed.">        } else if (file.startsWith(_contextPath)) {</span>
<span class="fc" id="L478">            result = file.substring(_contextPath.length());</span>
        } else {
<span class="nc" id="L480">            result = null;</span>
        }
<span class="fc bfc" id="L482" title="All 2 branches covered.">        return getControllingConstraint(result) != NULL_SECURITY_CONSTRAINT;</span>
    }

    /**
     * Returns an array containing the roles permitted to access the specified URL.
     *
     * @param url
     *            the url
     *
     * @return the permitted roles
     */
    String[] getPermittedRoles(URL url) {
        String result;
<span class="fc" id="L495">        String file = url.getFile();</span>
<span class="fc bfc" id="L496" title="All 2 branches covered.">        if (_contextPath.equals(&quot;&quot;)) {</span>
<span class="fc" id="L497">            result = file;</span>
<span class="pc bpc" id="L498" title="1 of 2 branches missed.">        } else if (file.startsWith(_contextPath)) {</span>
<span class="fc" id="L499">            result = file.substring(_contextPath.length());</span>
        } else {
<span class="nc" id="L501">            result = null;</span>
        }
<span class="fc" id="L503">        return getControllingConstraint(result).getPermittedRoles();</span>
    }

    /**
     * Gets the controlling constraint.
     *
     * @param urlPath
     *            the url path
     *
     * @return the controlling constraint
     */
    private SecurityConstraint getControllingConstraint(String urlPath) {
<span class="fc bfc" id="L515" title="All 2 branches covered.">        for (SecurityConstraint sc : _securityConstraints) {</span>
<span class="fc bfc" id="L516" title="All 2 branches covered.">            if (sc.controlsPath(urlPath)) {</span>
<span class="fc" id="L517">                return sc;</span>
            }
<span class="fc" id="L519">        }</span>
<span class="fc" id="L520">        return NULL_SECURITY_CONSTRAINT;</span>
    }

    /**
     * Gets the resource file.
     *
     * @param path
     *            the path
     *
     * @return the resource file
     */
    File getResourceFile(String path) {
<span class="fc bfc" id="L532" title="All 2 branches covered.">        String relativePath = path.startsWith(&quot;/&quot;) ? path.substring(1) : path;</span>
<span class="fc bfc" id="L533" title="All 2 branches covered.">        if (_contextDir == null) {</span>
<span class="fc" id="L534">            return Path.of(relativePath).toFile();</span>
        }
<span class="fc" id="L536">        return _contextDir.toPath().resolve(relativePath).toFile();</span>
    }

    /**
     * Gets the context parameters.
     *
     * @return the context parameters
     */
    Hashtable getContextParameters() {
<span class="fc" id="L545">        return _contextParameters;</span>
    }

    // ---------------------------------------- SessionListenerDispatcher methods
    // -------------------------------------------

    @Override
    public void sendSessionCreated(HttpSession session) {
<span class="fc" id="L553">        HttpSessionEvent event = new HttpSessionEvent(session);</span>

<span class="fc bfc" id="L555" title="All 2 branches covered.">        for (HttpSessionListener listener : _sessionListeners) {</span>
<span class="fc" id="L556">            listener.sessionCreated(event);</span>
<span class="fc" id="L557">        }</span>
<span class="fc" id="L558">    }</span>

    @Override
    public void sendSessionDestroyed(HttpSession session) {
<span class="fc" id="L562">        HttpSessionEvent event = new HttpSessionEvent(session);</span>

<span class="fc bfc" id="L564" title="All 2 branches covered.">        for (HttpSessionListener listener : _sessionListeners) {</span>
<span class="fc" id="L565">            listener.sessionDestroyed(event);</span>
<span class="fc" id="L566">        }</span>
<span class="fc" id="L567">    }</span>

    @Override
    public void sendAttributeAdded(HttpSession session, String name, Object value) {
<span class="fc" id="L571">        HttpSessionBindingEvent event = new HttpSessionBindingEvent(session, name, value);</span>

<span class="fc bfc" id="L573" title="All 2 branches covered.">        for (HttpSessionAttributeListener listener : _sessionAttributeListeners) {</span>
<span class="fc" id="L574">            listener.attributeAdded(event);</span>
<span class="fc" id="L575">        }</span>
<span class="fc" id="L576">    }</span>

    @Override
    public void sendAttributeReplaced(HttpSession session, String name, Object oldValue) {
<span class="fc" id="L580">        HttpSessionBindingEvent event = new HttpSessionBindingEvent(session, name, oldValue);</span>

<span class="fc bfc" id="L582" title="All 2 branches covered.">        for (HttpSessionAttributeListener listener : _sessionAttributeListeners) {</span>
<span class="fc" id="L583">            listener.attributeReplaced(event);</span>
<span class="fc" id="L584">        }</span>
<span class="fc" id="L585">    }</span>

    @Override
    public void sendAttributeRemoved(HttpSession session, String name, Object oldValue) {
<span class="fc" id="L589">        HttpSessionBindingEvent event = new HttpSessionBindingEvent(session, name, oldValue);</span>

<span class="fc bfc" id="L591" title="All 2 branches covered.">        for (HttpSessionAttributeListener listener : _sessionAttributeListeners) {</span>
<span class="fc" id="L592">            listener.attributeRemoved(event);</span>
<span class="fc" id="L593">        }</span>
<span class="fc" id="L594">    }</span>

    // --------------------------------------------------- private members
    // --------------------------------------------------

    /**
     * Register filters.
     *
     * @param document
     *            the document
     *
     * @throws SAXException
     *             the SAX exception
     */
    private void registerFilters(Document document) throws SAXException {
<span class="fc" id="L609">        Hashtable nameToClass = new Hashtable&lt;&gt;();</span>
<span class="fc" id="L610">        NodeList nl = document.getElementsByTagName(&quot;filter&quot;);</span>
<span class="fc bfc" id="L611" title="All 2 branches covered.">        for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="fc" id="L612">            registerFilterClass(nameToClass, (Element) nl.item(i));</span>
        }
<span class="fc" id="L614">        nl = document.getElementsByTagName(&quot;filter-mapping&quot;);</span>
<span class="fc bfc" id="L615" title="All 2 branches covered.">        for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="fc" id="L616">            registerFilter(nameToClass, (Element) nl.item(i));</span>
        }
<span class="fc" id="L618">        this._filters = nameToClass;</span>
<span class="fc" id="L619">    }</span>

    /**
     * Register filter class.
     *
     * @param mapping
     *            the mapping
     * @param filterElement
     *            the filter element
     *
     * @throws SAXException
     *             the SAX exception
     */
    private void registerFilterClass(Dictionary mapping, Element filterElement) throws SAXException {
<span class="fc" id="L633">        String filterName = XMLUtils.getChildNodeValue(filterElement, &quot;filter-name&quot;);</span>
<span class="fc" id="L634">        mapping.put(filterName, new FilterConfiguration(filterName, filterElement));</span>
<span class="fc" id="L635">    }</span>

    /**
     * Register filter.
     *
     * @param mapping
     *            the mapping
     * @param filterElement
     *            the filter element
     *
     * @throws SAXException
     *             the SAX exception
     */
    private void registerFilter(Dictionary mapping, Element filterElement) throws SAXException {
<span class="fc bfc" id="L649" title="All 2 branches covered.">        if (XMLUtils.hasChildNode(filterElement, &quot;servlet-name&quot;)) {</span>
<span class="fc" id="L650">            registerFilterForServlet(XMLUtils.getChildNodeValue(filterElement, &quot;servlet-name&quot;),</span>
<span class="fc" id="L651">                    (FilterConfiguration) mapping.get(XMLUtils.getChildNodeValue(filterElement, &quot;filter-name&quot;)));</span>
        }
<span class="fc bfc" id="L653" title="All 2 branches covered.">        if (XMLUtils.hasChildNode(filterElement, &quot;url-pattern&quot;)) {</span>
<span class="fc" id="L654">            registerFilterForUrl(XMLUtils.getChildNodeValue(filterElement, &quot;url-pattern&quot;),</span>
<span class="fc" id="L655">                    (FilterConfiguration) mapping.get(XMLUtils.getChildNodeValue(filterElement, &quot;filter-name&quot;)));</span>
        }
<span class="fc" id="L657">    }</span>

    /**
     * Register filter for url.
     *
     * @param resourceName
     *            the resource name
     * @param filterConfiguration
     *            the filter configuration
     */
    private void registerFilterForUrl(String resourceName, FilterConfiguration filterConfiguration) {
<span class="fc" id="L668">        _filterUrlMapping.put(resourceName, filterConfiguration);</span>
<span class="fc" id="L669">    }</span>

    /**
     * Register filter for servlet.
     *
     * @param servletName
     *            the servlet name
     * @param filterConfiguration
     *            the filter configuration
     */
    private void registerFilterForServlet(String servletName, FilterConfiguration filterConfiguration) {
<span class="fc" id="L680">        List list = (List) _filterMapping.get(servletName);</span>
<span class="fc bfc" id="L681" title="All 2 branches covered.">        if (list == null) {</span>
<span class="fc" id="L682">            list = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L683">            _filterMapping.put(servletName, list);</span>
        }
<span class="fc" id="L685">        list.add(filterConfiguration);</span>
<span class="fc" id="L686">    }</span>

    /**
     * Extract login configuration.
     *
     * @param document
     *            the document
     *
     * @throws MalformedURLException
     *             the malformed URL exception
     * @throws SAXException
     *             the SAX exception
     */
    private void extractLoginConfiguration(Document document) throws MalformedURLException, SAXException {
<span class="fc" id="L700">        NodeList nl = document.getElementsByTagName(&quot;login-config&quot;);</span>
<span class="fc bfc" id="L701" title="All 2 branches covered.">        if (nl.getLength() == 1) {</span>
<span class="fc" id="L702">            final Element loginConfigElement = (Element) nl.item(0);</span>
<span class="fc" id="L703">            String authenticationMethod = XMLUtils.getChildNodeValue(loginConfigElement, &quot;auth-method&quot;, &quot;BASIC&quot;);</span>
<span class="fc" id="L704">            _authenticationRealm = XMLUtils.getChildNodeValue(loginConfigElement, &quot;realm-name&quot;, &quot;&quot;);</span>
<span class="fc bfc" id="L705" title="All 2 branches covered.">            if (authenticationMethod.equalsIgnoreCase(&quot;BASIC&quot;)) {</span>
<span class="fc" id="L706">                _useBasicAuthentication = true;</span>
<span class="pc bpc" id="L707" title="1 of 2 branches missed.">                if (_authenticationRealm.isEmpty()) {</span>
<span class="nc" id="L708">                    throw new SAXException(&quot;No realm specified for BASIC Authorization&quot;);</span>
                }
<span class="pc bpc" id="L710" title="1 of 2 branches missed.">            } else if (authenticationMethod.equalsIgnoreCase(&quot;FORM&quot;)) {</span>
<span class="fc" id="L711">                _useFormAuthentication = true;</span>
<span class="pc bpc" id="L712" title="1 of 2 branches missed.">                if (_authenticationRealm.isEmpty()) {</span>
<span class="nc" id="L713">                    throw new SAXException(&quot;No realm specified for FORM Authorization&quot;);</span>
                }
<span class="fc" id="L715">                _loginURL = new URL(&quot;http&quot;, &quot;localhost&quot;,</span>
<span class="fc" id="L716">                        _contextPath + XMLUtils.getChildNodeValue(loginConfigElement, &quot;form-login-page&quot;));</span>
<span class="fc" id="L717">                _errorURL = new URL(&quot;http&quot;, &quot;localhost&quot;,</span>
<span class="fc" id="L718">                        _contextPath + XMLUtils.getChildNodeValue(loginConfigElement, &quot;form-error-page&quot;));</span>
            }
        }
<span class="fc" id="L721">    }</span>

    /**
     * Register servlets.
     *
     * @param document
     *            the document
     *
     * @throws SAXException
     *             the SAX exception
     */
    private void registerServlets(Document document) throws SAXException {
<span class="fc" id="L733">        Hashtable nameToClass = new Hashtable&lt;&gt;();</span>
<span class="fc" id="L734">        NodeList nl = document.getElementsByTagName(&quot;servlet&quot;);</span>
<span class="fc bfc" id="L735" title="All 2 branches covered.">        for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="fc" id="L736">            registerServletClass(nameToClass, (Element) nl.item(i));</span>
        }
<span class="fc" id="L738">        nl = document.getElementsByTagName(&quot;servlet-mapping&quot;);</span>
<span class="fc bfc" id="L739" title="All 2 branches covered.">        for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="fc" id="L740">            registerServlet(nameToClass, (Element) nl.item(i));</span>
        }
<span class="fc" id="L742">        this._servlets = nameToClass;</span>
<span class="fc" id="L743">    }</span>

    /**
     * Register servlet class.
     *
     * @param mapping
     *            the mapping
     * @param servletElement
     *            the servlet element
     *
     * @throws SAXException
     *             the SAX exception
     */
    private void registerServletClass(Dictionary mapping, Element servletElement) throws SAXException {
<span class="fc" id="L757">        mapping.put(XMLUtils.getChildNodeValue(servletElement, &quot;servlet-name&quot;),</span>
                new ServletConfiguration(servletElement));
<span class="fc" id="L759">    }</span>

    /**
     * Register servlet.
     *
     * @param mapping
     *            the mapping
     * @param servletElement
     *            the servlet element
     *
     * @throws SAXException
     *             the SAX exception
     */
    private void registerServlet(Dictionary mapping, Element servletElement) throws SAXException {
<span class="fc" id="L773">        registerServlet(XMLUtils.getChildNodeValue(servletElement, &quot;url-pattern&quot;),</span>
<span class="fc" id="L774">                (ServletConfiguration) mapping.get(XMLUtils.getChildNodeValue(servletElement, &quot;servlet-name&quot;)));</span>
<span class="fc" id="L775">    }</span>

    /**
     * Extract context parameters.
     *
     * @param document
     *            the document
     *
     * @throws SAXException
     *             the SAX exception
     */
    private void extractContextParameters(Document document) throws SAXException {
<span class="fc" id="L787">        NodeList nl = document.getElementsByTagName(&quot;context-param&quot;);</span>
<span class="fc bfc" id="L788" title="All 2 branches covered.">        for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="fc" id="L789">            Element param = (Element) nl.item(i);</span>
<span class="fc" id="L790">            String name = XMLUtils.getChildNodeValue(param, &quot;param-name&quot;);</span>
<span class="fc" id="L791">            String value = XMLUtils.getChildNodeValue(param, &quot;param-value&quot;);</span>
<span class="fc" id="L792">            _contextParameters.put(name, value);</span>
        }
<span class="fc" id="L794">    }</span>

    /**
     * Pattern matches.
     *
     * @param urlPattern
     *            the url pattern
     * @param urlPath
     *            the url path
     *
     * @return true, if successful
     */
    private static boolean patternMatches(String urlPattern, String urlPath) {
<span class="fc" id="L807">        return urlPattern.equals(urlPath);</span>
    }

    /**
     * Gets the display name.
     *
     * @return the display name
     */
    String getDisplayName() {
<span class="fc" id="L816">        return _displayName;</span>
    }

    // ============================================= SecurityCheckServlet class
    // =============================================

    /**
     * The Class SecurityCheckServlet.
     */
<span class="fc" id="L825">    static class SecurityCheckServlet extends HttpServlet {</span>

        /** The Constant serialVersionUID. */
        private static final long serialVersionUID = 1L;

        @Override
        protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
<span class="nc" id="L832">            handleLogin(req, resp);</span>
<span class="nc" id="L833">        }</span>

        @Override
        protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
<span class="fc" id="L837">            handleLogin(req, resp);</span>
<span class="fc" id="L838">        }</span>

        /**
         * Handle login.
         *
         * @param req
         *            the req
         * @param resp
         *            the resp
         *
         * @throws IOException
         *             Signals that an I/O exception has occurred.
         */
        private void handleLogin(HttpServletRequest req, HttpServletResponse resp) throws IOException {
<span class="fc" id="L852">            final String username = req.getParameter(&quot;j_username&quot;);</span>
<span class="fc" id="L853">            final String roleList = req.getParameter(&quot;j_password&quot;);</span>
<span class="fc" id="L854">            getServletSession(req).setUserInformation(username, ServletUnitHttpRequest.toArray(roleList));</span>
<span class="fc" id="L855">            resp.sendRedirect(getServletSession(req).getOriginalURL().toExternalForm());</span>
<span class="fc" id="L856">        }</span>

        /**
         * Gets the servlet session.
         *
         * @param req
         *            the req
         *
         * @return the servlet session
         */
        private ServletUnitHttpSession getServletSession(HttpServletRequest req) {
<span class="fc" id="L867">            return (ServletUnitHttpSession) req.getSession();</span>
        }

    }

    // ============================================= ServletConfiguration class
    // =============================================

    /** The Constant DONT_AUTOLOAD. */
    static final int DONT_AUTOLOAD = Integer.MIN_VALUE;

    /** The Constant ANY_LOAD_ORDER. */
    static final int ANY_LOAD_ORDER = Integer.MAX_VALUE;

    /**
     * The Class ServletConfiguration.
     */
    class ServletConfiguration extends WebResourceConfiguration {

        /** The servlet. */
        private Servlet _servlet;

        /** The servlet name. */
        private String _servletName;

        /** The jsp file. */
        private String _jspFile;

        /** The load order. */
<span class="fc" id="L896">        private int _loadOrder = DONT_AUTOLOAD;</span>

        /**
         * Instantiates a new servlet configuration.
         *
         * @param className
         *            the class name
         */
<span class="fc" id="L904">        ServletConfiguration(String className) {</span>
<span class="fc" id="L905">            super(className);</span>
<span class="fc" id="L906">        }</span>

        /**
         * Instantiates a new servlet configuration.
         *
         * @param className
         *            the class name
         * @param initParams
         *            the init params
         */
<span class="fc" id="L916">        ServletConfiguration(String className, Hashtable initParams) {</span>
<span class="fc" id="L917">            super(className, initParams);</span>
<span class="fc" id="L918">        }</span>

        /**
         * Instantiates a new servlet configuration.
         *
         * @param servletElement
         *            the servlet element
         *
         * @throws SAXException
         *             the SAX exception
         */
<span class="fc" id="L929">        ServletConfiguration(Element servletElement) throws SAXException {</span>
<span class="fc" id="L930">            super(servletElement, &quot;servlet-class&quot;, XMLUtils.getChildNodeValue(servletElement, &quot;servlet-class&quot;,</span>
                    &quot;org.apache.jasper.servlet.JspServlet&quot;));
<span class="fc" id="L932">            _servletName = XMLUtils.getChildNodeValue(servletElement, &quot;servlet-name&quot;);</span>
<span class="fc" id="L933">            _jspFile = XMLUtils.getChildNodeValue(servletElement, &quot;jsp-file&quot;, &quot;&quot;);</span>
<span class="pc bpc" id="L934" title="1 of 2 branches missed.">            if (&quot;&quot;.equals(_jspFile)) {</span>
<span class="fc" id="L935">                _jspFile = null;</span>
            }
<span class="fc" id="L937">            final NodeList loadOrder = servletElement.getElementsByTagName(&quot;load-on-startup&quot;);</span>
<span class="fc bfc" id="L938" title="All 2 branches covered.">            for (int i = 0; i &lt; loadOrder.getLength(); i++) {</span>
<span class="fc" id="L939">                String order = XMLUtils.getTextValue(loadOrder.item(i));</span>
                try {
<span class="fc" id="L941">                    _loadOrder = Integer.parseInt(order);</span>
<span class="fc" id="L942">                } catch (NumberFormatException e) {</span>
<span class="fc" id="L943">                    _loadOrder = ANY_LOAD_ORDER;</span>
<span class="fc" id="L944">                }</span>
            }
<span class="fc" id="L946">        }</span>

        /**
         * Gets the servlet.
         *
         * @return the servlet
         *
         * @throws ClassNotFoundException
         *             the class not found exception
         * @throws InstantiationException
         *             the instantiation exception
         * @throws IllegalAccessException
         *             the illegal access exception
         * @throws ServletException
         *             the servlet exception
         * @throws IllegalArgumentException
         *             the illegal argument exception
         * @throws InvocationTargetException
         *             the invocation target exception
         * @throws NoSuchMethodException
         *             the no such method exception
         * @throws SecurityException
         *             the security exception
         */
        synchronized Servlet getServlet()
                throws ClassNotFoundException, InstantiationException, IllegalAccessException, ServletException,
                IllegalArgumentException, InvocationTargetException, NoSuchMethodException, SecurityException {
<span class="fc bfc" id="L973" title="All 2 branches covered.">            if (_servlet == null) {</span>
<span class="fc" id="L974">                Class servletClass = Class.forName(getClassName());</span>
<span class="fc" id="L975">                _servlet = (Servlet) servletClass.getDeclaredConstructor().newInstance();</span>
<span class="fc bfc" id="L976" title="All 2 branches covered.">                String servletName = _servletName != null ? _servletName : _servlet.getClass().getName();</span>
<span class="fc" id="L977">                _servlet.init(new ServletUnitServletConfig(servletName, WebApplication.this, getInitParams()));</span>
            }

<span class="fc" id="L980">            return _servlet;</span>
        }

        @Override
        synchronized void destroyResource() {
<span class="fc bfc" id="L985" title="All 2 branches covered.">            if (_servlet != null) {</span>
<span class="fc" id="L986">                _servlet.destroy();</span>
            }
<span class="fc" id="L988">        }</span>

        /**
         * Gets the servlet name.
         *
         * @return the servlet name
         */
        String getServletName() {
<span class="fc" id="L996">            return _servletName;</span>
        }

        @Override
        boolean isLoadOnStartup() {
<span class="fc bfc" id="L1001" title="All 2 branches covered.">            return _loadOrder != DONT_AUTOLOAD;</span>
        }

        /**
         * Gets the load order.
         *
         * @return the load order
         */
        public int getLoadOrder() {
<span class="fc" id="L1010">            return _loadOrder;</span>
        }

        /**
         * Gets the jsp file.
         *
         * @return the jsp file
         */
        public Object getJspFile() {
<span class="nc" id="L1019">            return this._jspFile;</span>
        }
    }

    // ============================================= FilterConfiguration class
    // =============================================

    /**
     * The Class FilterConfiguration.
     */
    class FilterConfiguration extends WebResourceConfiguration implements FilterMetaData {

        /** The filter. */
        private Filter _filter;

        /** The name. */
        private String _name;

        /**
         * Instantiates a new filter configuration.
         *
         * @param name
         *            the name
         * @param filterElement
         *            the filter element
         *
         * @throws SAXException
         *             the SAX exception
         */
<span class="fc" id="L1048">        FilterConfiguration(String name, Element filterElement) throws SAXException {</span>
<span class="fc" id="L1049">            super(filterElement, &quot;filter-class&quot;);</span>
<span class="fc" id="L1050">            _name = name;</span>
<span class="fc" id="L1051">        }</span>

        @Override
        public synchronized Filter getFilter() throws ServletException {
            try {
<span class="fc bfc" id="L1056" title="All 2 branches covered.">                if (_filter == null) {</span>
<span class="fc" id="L1057">                    Class filterClass = Class.forName(getClassName());</span>
<span class="fc" id="L1058">                    _filter = (Filter) filterClass.getDeclaredConstructor().newInstance();</span>
<span class="fc" id="L1059">                    _filter.init(new FilterConfigImpl(_name, getServletContext(), getInitParams()));</span>
                }

<span class="fc" id="L1062">                return _filter;</span>
<span class="nc" id="L1063">            } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L1064">                throw new ServletException(&quot;Did not find filter class: &quot; + getClassName());</span>
<span class="nc" id="L1065">            } catch (IllegalAccessException e) {</span>
<span class="nc" id="L1066">                throw new ServletException(&quot;Filter class &quot; + getClassName() + &quot; lacks a public no-arg constructor&quot;);</span>
<span class="nc" id="L1067">            } catch (InstantiationException | IllegalArgumentException | InvocationTargetException</span>
                    | NoSuchMethodException | SecurityException e) {
<span class="nc" id="L1069">                throw new ServletException(&quot;Filter class &quot; + getClassName() + &quot; could not be instantiated.&quot;);</span>
<span class="nc" id="L1070">            } catch (ClassCastException e) {</span>
<span class="nc" id="L1071">                throw new ServletException(</span>
<span class="nc" id="L1072">                        &quot;Filter class &quot; + getClassName() + &quot; does not implement&quot; + Filter.class.getName());</span>
            }
        }

        @Override
        boolean isLoadOnStartup() {
<span class="nc" id="L1078">            return false;</span>
        }

        @Override
        synchronized void destroyResource() {
<span class="nc bnc" id="L1083" title="All 2 branches missed.">            if (_filter != null) {</span>
<span class="nc" id="L1084">                _filter.destroy();</span>
            }
<span class="nc" id="L1086">        }</span>
    }

    // =================================== SecurityConstract interface and implementations
    // ==================================

    /**
     * The Interface SecurityConstraint.
     */
    interface SecurityConstraint {

        /**
         * Controls path.
         *
         * @param urlPath
         *            the url path
         *
         * @return true, if successful
         */
        boolean controlsPath(String urlPath);

        /**
         * Gets the permitted roles.
         *
         * @return the permitted roles
         */
        String[] getPermittedRoles();
    }

    /**
     * The Class NullSecurityConstraint.
     */
<span class="fc" id="L1118">    static class NullSecurityConstraint implements SecurityConstraint {</span>

        /** The Constant NO_ROLES. */
<span class="fc" id="L1121">        private static final String[] NO_ROLES = {};</span>

        @Override
        public boolean controlsPath(String urlPath) {
<span class="nc" id="L1125">            return false;</span>
        }

        @Override
        public String[] getPermittedRoles() {
<span class="nc" id="L1130">            return NO_ROLES;</span>
        }
    }

    /**
     * The Class SecurityConstraintImpl.
     */
    static class SecurityConstraintImpl implements SecurityConstraint {

        /**
         * Instantiates a new security constraint impl.
         *
         * @param root
         *            the root
         *
         * @throws SAXException
         *             the SAX exception
         */
<span class="fc" id="L1148">        SecurityConstraintImpl(Element root) throws SAXException {</span>
<span class="fc" id="L1149">            final NodeList roleNames = root.getElementsByTagName(&quot;role-name&quot;);</span>
<span class="fc bfc" id="L1150" title="All 2 branches covered.">            for (int i = 0; i &lt; roleNames.getLength(); i++) {</span>
<span class="fc" id="L1151">                _roleList.add(XMLUtils.getTextValue(roleNames.item(i)));</span>
            }

<span class="fc" id="L1154">            final NodeList resources = root.getElementsByTagName(&quot;web-resource-collection&quot;);</span>
<span class="fc bfc" id="L1155" title="All 2 branches covered.">            for (int i = 0; i &lt; resources.getLength(); i++) {</span>
<span class="fc" id="L1156">                _resources.add(new WebResourceCollection((Element) resources.item(i)));</span>
            }
<span class="fc" id="L1158">        }</span>

        @Override
        public boolean controlsPath(String urlPath) {
<span class="fc bfc" id="L1162" title="All 2 branches covered.">            return getMatchingCollection(urlPath) != null;</span>
        }

        @Override
        public String[] getPermittedRoles() {
<span class="fc bfc" id="L1167" title="All 2 branches covered.">            if (_roles == null) {</span>
<span class="fc" id="L1168">                _roles = _roleList.toArray(new String[_roleList.size()]);</span>
            }
<span class="fc" id="L1170">            return _roles;</span>
        }

        /** The roles. */
        private String[] _roles;

        /** The role list. */
<span class="fc" id="L1177">        private List&lt;String&gt; _roleList = new ArrayList&lt;&gt;();</span>

        /** The resources. */
<span class="fc" id="L1180">        private List&lt;WebResourceCollection&gt; _resources = new ArrayList&lt;&gt;();</span>

        /**
         * Gets the matching collection.
         *
         * @param urlPath
         *            the url path
         *
         * @return the matching collection
         */
        public WebResourceCollection getMatchingCollection(String urlPath) {
<span class="fc bfc" id="L1191" title="All 2 branches covered.">            for (WebResourceCollection wrc : _resources) {</span>
<span class="fc bfc" id="L1192" title="All 2 branches covered.">                if (wrc.controlsPath(urlPath)) {</span>
<span class="fc" id="L1193">                    return wrc;</span>
                }
<span class="fc" id="L1195">            }</span>
<span class="fc" id="L1196">            return null;</span>
        }

        /**
         * The Class WebResourceCollection.
         */
        class WebResourceCollection {

            /**
             * Instantiates a new web resource collection.
             *
             * @param root
             *            the root
             *
             * @throws SAXException
             *             the SAX exception
             */
<span class="fc" id="L1213">            WebResourceCollection(Element root) throws SAXException {</span>
<span class="fc" id="L1214">                final NodeList urlPatterns = root.getElementsByTagName(&quot;url-pattern&quot;);</span>
<span class="fc bfc" id="L1215" title="All 2 branches covered.">                for (int i = 0; i &lt; urlPatterns.getLength(); i++) {</span>
<span class="fc" id="L1216">                    _urlPatterns.add(XMLUtils.getTextValue(urlPatterns.item(i)));</span>
                }
<span class="fc" id="L1218">            }</span>

            /**
             * Controls path.
             *
             * @param urlPath
             *            the url path
             *
             * @return true, if successful
             */
            boolean controlsPath(String urlPath) {
<span class="fc bfc" id="L1229" title="All 2 branches covered.">                for (String pattern : _urlPatterns) {</span>
<span class="fc bfc" id="L1230" title="All 2 branches covered.">                    if (patternMatches(pattern, urlPath)) {</span>
<span class="fc" id="L1231">                        return true;</span>
                    }
<span class="fc" id="L1233">                }</span>
<span class="fc" id="L1234">                return false;</span>
            }

            /** The url patterns. */
<span class="fc" id="L1238">            private List&lt;String&gt; _urlPatterns = new ArrayList&lt;&gt;();</span>
        }
    }

    /** The Constant NO_FILTERS. */
<span class="fc" id="L1243">    static final FilterMetaData[] NO_FILTERS = {};</span>

    /**
     * The Class ServletRequestImpl.
     */
    static class ServletRequestImpl implements ServletMetaData {

        /** The url. */
        private URL _url;

        /** The full servlet path. */
        private String _fullServletPath;

        /** The mapping. */
        private WebResourceMapping _mapping;

        /** The filters per name. */
        private Hashtable _filtersPerName;

        /** The filters per url. */
        private FilterUrlMap _filtersPerUrl;

        /**
         * Instantiates a new servlet request impl.
         *
         * @param url
         *            the url
         * @param servletPath
         *            the servlet path
         * @param mapping
         *            the mapping
         * @param filtersPerName
         *            the filters per name
         * @param filtersPerUrl
         *            the filters per url
         */
        ServletRequestImpl(URL url, String servletPath, WebResourceMapping mapping, Hashtable filtersPerName,
<span class="fc" id="L1280">                FilterUrlMap filtersPerUrl) {</span>
<span class="fc" id="L1281">            _url = url;</span>
<span class="fc" id="L1282">            _fullServletPath = servletPath;</span>
<span class="fc" id="L1283">            _mapping = mapping;</span>
<span class="fc" id="L1284">            _filtersPerName = filtersPerName;</span>
<span class="fc" id="L1285">            _filtersPerUrl = filtersPerUrl;</span>
<span class="fc" id="L1286">        }</span>

        /**
         * get the Servlet
         *
         * @return the Servlet from the configuration
         *
         * @throws ServletException
         *             - e.g. if no configuration is available
         */
        @Override
        public Servlet getServlet() throws ServletException {
<span class="fc bfc" id="L1298" title="All 2 branches covered.">            if (getConfiguration() == null) {</span>
<span class="fc" id="L1299">                throw new HttpNotFoundException(&quot;No servlet mapping defined&quot;, _url);</span>
            }

            try {
<span class="fc" id="L1303">                return getConfiguration().getServlet();</span>
<span class="nc" id="L1304">            } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L1305">                throw new HttpNotFoundException(_url, e);</span>
<span class="nc" id="L1306">            } catch (IllegalAccessException | InstantiationException | IllegalArgumentException</span>
                    | InvocationTargetException | NoSuchMethodException | SecurityException e) {
<span class="nc" id="L1308">                throw new HttpInternalErrorException(_url, e);</span>
            }
        }

        /**
         * get the ServletPath the decoded ServletPath
         */
        @Override
        public String getServletPath() {
<span class="pc bpc" id="L1317" title="1 of 2 branches missed.">            return _mapping == null ? null : HttpUnitUtils.decode(_mapping.getServletPath(_fullServletPath));</span>
        }

        /**
         * get the Path Information
         *
         * @return the decode path
         */
        @Override
        public String getPathInfo() {
<span class="pc bpc" id="L1327" title="1 of 2 branches missed.">            return _mapping == null ? null : HttpUnitUtils.decode(_mapping.getPathInfo(_fullServletPath));</span>
        }

        @Override
        public FilterMetaData[] getFilters() {
<span class="fc bfc" id="L1332" title="All 2 branches covered.">            if (getConfiguration() == null) {</span>
<span class="fc" id="L1333">                return NO_FILTERS;</span>
            }

<span class="fc" id="L1336">            List&lt;FilterMetaData&gt; filters = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1337">            addFiltersForPath(filters, _fullServletPath);</span>
<span class="fc" id="L1338">            addFiltersForServletWithName(filters, getConfiguration().getServletName());</span>

<span class="fc" id="L1340">            return filters.toArray(new FilterMetaData[filters.size()]);</span>
        }

        /**
         * Adds the filters for path.
         *
         * @param filters
         *            the filters
         * @param fullServletPath
         *            the full servlet path
         */
        private void addFiltersForPath(List&lt;FilterMetaData&gt; filters, String fullServletPath) {
<span class="fc" id="L1352">            FilterMetaData[] matches = _filtersPerUrl.getMatchingFilters(fullServletPath);</span>
<span class="fc" id="L1353">            Collections.addAll(filters, matches);</span>
<span class="fc" id="L1354">        }</span>

        /**
         * Adds the filters for servlet with name.
         *
         * @param filters
         *            the filters
         * @param servletName
         *            the servlet name
         */
        private void addFiltersForServletWithName(List&lt;FilterMetaData&gt; filters, String servletName) {
<span class="fc bfc" id="L1365" title="All 2 branches covered.">            if (servletName == null) {</span>
<span class="fc" id="L1366">                return;</span>
            }
<span class="fc" id="L1368">            List&lt;FilterMetaData&gt; matches = (List&lt;FilterMetaData&gt;) _filtersPerName.get(servletName);</span>
<span class="fc bfc" id="L1369" title="All 2 branches covered.">            if (matches != null) {</span>
<span class="fc" id="L1370">                filters.addAll(matches);</span>
            }
<span class="fc" id="L1372">        }</span>

        /**
         * Gets the configuration.
         *
         * @return the configuration
         */
        private ServletConfiguration getConfiguration() {
<span class="fc bfc" id="L1380" title="All 2 branches covered.">            return _mapping == null ? null : (ServletConfiguration) _mapping.getConfiguration();</span>
        }
    }

    /**
     * mapping for WebResources.
     */
    static class WebResourceMapping {

        /** The configuration. */
        private WebResourceConfiguration _configuration;

        /**
         * Gets the configuration.
         *
         * @return the configuration
         */
        WebResourceConfiguration getConfiguration() {
<span class="fc" id="L1398">            return _configuration;</span>
        }

        /**
         * Instantiates a new web resource mapping.
         *
         * @param configuration
         *            the configuration
         */
<span class="fc" id="L1407">        WebResourceMapping(WebResourceConfiguration configuration) {</span>
<span class="fc" id="L1408">            _configuration = configuration;</span>
<span class="fc" id="L1409">        }</span>

        /**
         * Returns the portion of the request path which was actually used to select the servlet. This default
         * implementation returns the full specified path.
         *
         * @param requestPath
         *            the full path of the request, relative to the application root.
         *
         * @return the servlet path
         */
        String getServletPath(String requestPath) {
<span class="fc" id="L1421">            return requestPath;</span>
        }

        /**
         * Returns the portion of the request path which was not used to select the servlet, and can be used as data by
         * the servlet. This default implementation returns null.
         *
         * @param requestPath
         *            the full path of the request, relative to the application root.
         *
         * @return the path info
         */
        String getPathInfo(String requestPath) {
<span class="fc" id="L1434">            return null;</span>
        }

        /**
         * Destroy resource.
         */
        public void destroyResource() {
<span class="fc" id="L1441">            getConfiguration().destroyResource();</span>
<span class="fc" id="L1442">        }</span>
    }

    /**
     * The Class PartialMatchWebResourceMapping.
     */
    static class PartialMatchWebResourceMapping extends WebResourceMapping {

        /** The prefix. */
        private String _prefix;

        /**
         * Instantiates a new partial match web resource mapping.
         *
         * @param configuration
         *            the configuration
         * @param prefix
         *            the prefix
         */
        public PartialMatchWebResourceMapping(WebResourceConfiguration configuration, String prefix) {
<span class="fc" id="L1462">            super(configuration);</span>
<span class="pc bpc" id="L1463" title="1 of 2 branches missed.">            if (!prefix.endsWith(&quot;/*&quot;)) {</span>
<span class="nc" id="L1464">                throw new IllegalArgumentException(prefix + &quot; does not end with '/*'&quot;);</span>
            }
<span class="fc" id="L1466">            _prefix = prefix.substring(0, prefix.length() - 2);</span>
<span class="fc" id="L1467">        }</span>

        @Override
        String getServletPath(String requestPath) {
<span class="fc" id="L1471">            return _prefix;</span>
        }

        @Override
        String getPathInfo(String requestPath) {
<span class="fc bfc" id="L1476" title="All 2 branches covered.">            return requestPath.length() &gt; _prefix.length() ? requestPath.substring(_prefix.length()) : null;</span>
        }
    }

    /**
     * A utility class for mapping web resources to url patterns. This implements the matching algorithm documented in
     * section 10 of the JSDK-2.2 reference.
     */
<span class="fc" id="L1484">    class WebResourceMap {</span>

        /** The exact matches. */
<span class="fc" id="L1487">        private final Map _exactMatches = new HashMap&lt;&gt;();</span>

        /** The extensions. */
<span class="fc" id="L1490">        private final Map _extensions = new HashMap&lt;&gt;();</span>

        /** The url tree. */
<span class="fc" id="L1493">        private final Map _urlTree = new HashMap&lt;&gt;();</span>

        /** The default mapping. */
        private WebResourceMapping _defaultMapping;

        /**
         * Put.
         *
         * @param mapping
         *            the mapping
         * @param configuration
         *            the configuration
         */
        void put(String mapping, WebResourceConfiguration configuration) {
<span class="fc bfc" id="L1507" title="All 2 branches covered.">            if (mapping.equals(&quot;/&quot;)) {</span>
<span class="fc" id="L1508">                _defaultMapping = new WebResourceMapping(configuration);</span>
<span class="fc bfc" id="L1509" title="All 2 branches covered.">            } else if (mapping.startsWith(&quot;*.&quot;)) {</span>
<span class="fc" id="L1510">                _extensions.put(mapping.substring(2), new WebResourceMapping(configuration));</span>
<span class="pc bpc" id="L1511" title="1 of 4 branches missed.">            } else if (!mapping.startsWith(&quot;/&quot;) || !mapping.endsWith(&quot;/*&quot;)) {</span>
<span class="fc" id="L1512">                _exactMatches.put(mapping, new WebResourceMapping(configuration));</span>
            } else {
<span class="fc" id="L1514">                ParsedPath path = new ParsedPath(mapping);</span>
<span class="fc" id="L1515">                Map context = _urlTree;</span>
<span class="pc bpc" id="L1516" title="1 of 2 branches missed.">                while (path.hasNext()) {</span>
<span class="fc" id="L1517">                    String part = path.next();</span>
<span class="fc bfc" id="L1518" title="All 2 branches covered.">                    if (part.equals(&quot;*&quot;)) {</span>
<span class="fc" id="L1519">                        context.put(&quot;*&quot;, new PartialMatchWebResourceMapping(configuration, mapping));</span>
<span class="fc" id="L1520">                        return;</span>
                    }
<span class="pc bpc" id="L1522" title="1 of 2 branches missed.">                    if (!context.containsKey(part)) {</span>
<span class="fc" id="L1523">                        context.put(part, new HashMap&lt;&gt;());</span>
                    }
<span class="fc" id="L1525">                    context = (Map) context.get(part);</span>
<span class="fc" id="L1526">                }</span>
            }
<span class="fc" id="L1528">        }</span>

        /**
         * Gets the.
         *
         * @param url
         *            the url
         *
         * @return the servlet meta data
         */
        ServletMetaData get(URL url) {
<span class="fc" id="L1539">            String file = url.getFile();</span>
<span class="fc bfc" id="L1540" title="All 2 branches covered.">            if (!file.startsWith(_contextPath)) {</span>
<span class="fc" id="L1541">                throw new HttpNotFoundException(&quot;File path does not begin with '&quot; + _contextPath + &quot;'&quot;, url);</span>
            }

<span class="fc" id="L1544">            String servletPath = getServletPath(file.substring(_contextPath.length()));</span>

<span class="fc bfc" id="L1546" title="All 2 branches covered.">            if (servletPath.endsWith(&quot;j_security_check&quot;)) {</span>
<span class="fc" id="L1547">                return new ServletRequestImpl(url, servletPath, SECURITY_CHECK_MAPPING, _filterMapping,</span>
                        _filterUrlMapping);
            }
<span class="fc" id="L1550">            return new ServletRequestImpl(url, servletPath, getMapping(servletPath), _filterMapping, _filterUrlMapping);</span>
        }

        /**
         * Gets the servlet path.
         *
         * @param urlFile
         *            the url file
         *
         * @return the servlet path
         */
        private String getServletPath(String urlFile) {
<span class="fc bfc" id="L1562" title="All 2 branches covered.">            if (urlFile.indexOf('?') &lt; 0) {</span>
<span class="fc" id="L1563">                return urlFile;</span>
            }
<span class="fc" id="L1565">            return urlFile.substring(0, urlFile.indexOf('?'));</span>
        }

        /**
         * Destroy web resources.
         */
        public void destroyWebResources() {
<span class="pc bpc" id="L1572" title="1 of 2 branches missed.">            if (_defaultMapping != null) {</span>
<span class="nc" id="L1573">                _defaultMapping.destroyResource();</span>
            }
<span class="fc" id="L1575">            destroyWebResources(_exactMatches);</span>
<span class="fc" id="L1576">            destroyWebResources(_extensions);</span>
<span class="fc" id="L1577">            destroyWebResources(_urlTree);</span>
<span class="fc" id="L1578">        }</span>

        /**
         * Destroy web resources.
         *
         * @param map
         *            the map
         */
        private void destroyWebResources(Map map) {
<span class="fc bfc" id="L1587" title="All 2 branches covered.">            for (Object o : map.values()) {</span>
<span class="pc bpc" id="L1588" title="1 of 2 branches missed.">                if (o instanceof WebResourceMapping) {</span>
<span class="fc" id="L1589">                    WebResourceMapping webResourceMapping = (WebResourceMapping) o;</span>
<span class="fc" id="L1590">                    webResourceMapping.destroyResource();</span>
<span class="fc" id="L1591">                } else {</span>
<span class="nc" id="L1592">                    destroyWebResources((Map) o);</span>
                }
<span class="fc" id="L1594">            }</span>
<span class="fc" id="L1595">        }</span>

        /**
         * Auto load servlets.
         */
        void autoLoadServlets() {
<span class="fc" id="L1601">            ArrayList autoLoadable = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L1602" title="1 of 4 branches missed.">            if (_defaultMapping != null &amp;&amp; _defaultMapping.getConfiguration().isLoadOnStartup()) {</span>
<span class="nc" id="L1603">                autoLoadable.add(_defaultMapping.getConfiguration());</span>
            }
<span class="fc" id="L1605">            collectAutoLoadableServlets(autoLoadable, _exactMatches);</span>
<span class="fc" id="L1606">            collectAutoLoadableServlets(autoLoadable, _extensions);</span>
<span class="fc" id="L1607">            collectAutoLoadableServlets(autoLoadable, _urlTree);</span>
<span class="fc bfc" id="L1608" title="All 2 branches covered.">            if (autoLoadable.isEmpty()) {</span>
<span class="fc" id="L1609">                return;</span>
            }

<span class="fc" id="L1612">            Collections.sort(autoLoadable, (o1, o2) -&gt; {</span>
<span class="fc" id="L1613">                ServletConfiguration sc1 = (ServletConfiguration) o1;</span>
<span class="fc" id="L1614">                ServletConfiguration sc2 = (ServletConfiguration) o2;</span>
<span class="fc bfc" id="L1615" title="All 2 branches covered.">                return sc1.getLoadOrder() &lt;= sc2.getLoadOrder() ? -1 : +1;</span>
            });
<span class="fc bfc" id="L1617" title="All 2 branches covered.">            for (Iterator iterator = autoLoadable.iterator(); iterator.hasNext();) {</span>
<span class="fc" id="L1618">                ServletConfiguration servletConfiguration = (ServletConfiguration) iterator.next();</span>
                try {
<span class="fc" id="L1620">                    servletConfiguration.getServlet();</span>
<span class="nc" id="L1621">                } catch (Exception e) {</span>
<span class="nc" id="L1622">                    HttpUnitUtils.handleException(e);</span>
<span class="nc" id="L1623">                    throw new RuntimeException(</span>
<span class="nc" id="L1624">                            &quot;Unable to autoload servlet: &quot; + servletConfiguration.getClassName() + &quot;: &quot; + e);</span>
<span class="fc" id="L1625">                }</span>
<span class="fc" id="L1626">            }</span>
<span class="fc" id="L1627">        }</span>

        /**
         * Collect auto loadable servlets.
         *
         * @param collection
         *            the collection
         * @param map
         *            the map
         */
        private void collectAutoLoadableServlets(Collection collection, Map map) {
<span class="fc bfc" id="L1638" title="All 2 branches covered.">            for (Object o : map.values()) {</span>
<span class="fc bfc" id="L1639" title="All 2 branches covered.">                if (o instanceof WebResourceMapping) {</span>
<span class="fc" id="L1640">                    WebResourceMapping servletMapping = (WebResourceMapping) o;</span>
<span class="fc bfc" id="L1641" title="All 2 branches covered.">                    if (servletMapping.getConfiguration().isLoadOnStartup()) {</span>
<span class="fc" id="L1642">                        collection.add(servletMapping.getConfiguration());</span>
                    }
<span class="fc" id="L1644">                } else {</span>
<span class="fc" id="L1645">                    collectAutoLoadableServlets(collection, (Map) o);</span>
                }
<span class="fc" id="L1647">            }</span>
<span class="fc" id="L1648">        }</span>

        /**
         * Gets the mapping.
         *
         * @param url
         *            the url
         *
         * @return the mapping
         */
        private WebResourceMapping getMapping(String url) {
<span class="fc bfc" id="L1659" title="All 2 branches covered.">            if (_exactMatches.containsKey(url)) {</span>
<span class="fc" id="L1660">                return (WebResourceMapping) _exactMatches.get(url);</span>
            }

<span class="fc" id="L1663">            Map context = getContextForLongestPathPrefix(url);</span>
<span class="fc bfc" id="L1664" title="All 2 branches covered.">            if (context.containsKey(&quot;*&quot;)) {</span>
<span class="fc" id="L1665">                return (WebResourceMapping) context.get(&quot;*&quot;);</span>
            }

<span class="fc bfc" id="L1668" title="All 2 branches covered.">            if (_extensions.containsKey(getExtension(url))) {</span>
<span class="fc" id="L1669">                return (WebResourceMapping) _extensions.get(getExtension(url));</span>
            }

<span class="pc bpc" id="L1672" title="1 of 2 branches missed.">            if (_urlTree.containsKey(&quot;/&quot;)) {</span>
<span class="nc" id="L1673">                return (WebResourceMapping) _urlTree.get(&quot;/&quot;);</span>
            }

<span class="fc bfc" id="L1676" title="All 2 branches covered.">            if (_defaultMapping != null) {</span>
<span class="fc" id="L1677">                return _defaultMapping;</span>
            }

<span class="fc" id="L1680">            final String prefix = &quot;/servlet/&quot;;</span>
<span class="fc bfc" id="L1681" title="All 2 branches covered.">            if (!url.startsWith(prefix)) {</span>
<span class="fc" id="L1682">                return null;</span>
            }

<span class="fc" id="L1685">            String className = url.substring(prefix.length());</span>
            try {
<span class="fc" id="L1687">                Class.forName(className);</span>
<span class="fc" id="L1688">                return new WebResourceMapping(new ServletConfiguration(className));</span>
<span class="nc" id="L1689">            } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L1690">                return null;</span>
            }
        }

        /**
         * Gets the context for longest path prefix.
         *
         * @param url
         *            the url
         *
         * @return the context for longest path prefix
         */
        private Map getContextForLongestPathPrefix(String url) {
<span class="fc" id="L1703">            Map context = _urlTree;</span>

<span class="fc" id="L1705">            ParsedPath path = new ParsedPath(url);</span>
<span class="fc bfc" id="L1706" title="All 2 branches covered.">            while (path.hasNext()) {</span>
<span class="fc" id="L1707">                String part = path.next();</span>
<span class="fc bfc" id="L1708" title="All 2 branches covered.">                if (!context.containsKey(part)) {</span>
<span class="fc" id="L1709">                    break;</span>
                }
<span class="fc" id="L1711">                context = (Map) context.get(part);</span>
<span class="fc" id="L1712">            }</span>
<span class="fc" id="L1713">            return context;</span>
        }

        /**
         * Gets the extension.
         *
         * @param url
         *            the url
         *
         * @return the extension
         */
        private String getExtension(String url) {
<span class="fc" id="L1725">            int index = url.lastIndexOf('.');</span>
<span class="pc bpc" id="L1726" title="1 of 4 branches missed.">            if (index == -1 || index &gt;= url.length() - 1) {</span>
<span class="fc" id="L1727">                return &quot;&quot;;</span>
            }
<span class="fc" id="L1729">            return url.substring(index + 1);</span>
        }

    }

    /**
     * return the given ServletConfiguration for the given servlet name.
     *
     * @param servletName
     *            the servlet name
     *
     * @return the corresponding ServletConfiguration
     */
    public ServletConfiguration getServletByName(String servletName) {
<span class="fc" id="L1743">        return (ServletConfiguration) _servlets.get(servletName);</span>
    }

}

/**
 * A utility class for parsing URLs into paths
 */
class ParsedPath {

    private final String path;
<span class="fc" id="L1754">    private int position = 0;</span>
    static final char seperator_char = '/';

    /**
     * Creates a new parsed path for the given path value
     *
     * @param path
     *            the path
     */
<span class="fc" id="L1763">    ParsedPath(String path) {</span>
<span class="pc bpc" id="L1764" title="1 of 2 branches missed.">        if (path.charAt(0) != seperator_char) {</span>
<span class="nc" id="L1765">            throw new IllegalArgumentException(&quot;Illegal path '&quot; + path + &quot;', does not begin with &quot; + seperator_char);</span>
        }
<span class="fc" id="L1767">        this.path = path;</span>
<span class="fc" id="L1768">    }</span>

    /**
     * Returns true if there are more parts left, otherwise false
     */
    public final boolean hasNext() {
<span class="fc bfc" id="L1774" title="All 2 branches covered.">        return position &lt; path.length();</span>
    }

    /**
     * Returns the next part in the path
     */
    public final String next() {
<span class="fc" id="L1781">        int offset = position + 1;</span>
<span class="fc bfc" id="L1782" title="All 4 branches covered.">        while (offset &lt; path.length() &amp;&amp; path.charAt(offset) != seperator_char) {</span>
<span class="fc" id="L1783">            offset++;</span>
        }
<span class="fc" id="L1785">        String result = path.substring(position + 1, offset);</span>
<span class="fc" id="L1786">        position = offset;</span>
<span class="fc" id="L1787">        return result;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>